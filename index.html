<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack Pro - Body Recomposition</title>
    <meta name="theme-color" content="#6366f1">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="exercises.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FitTrack Pro</h1>
            <p>Advanced Body Recomposition Tracking</p>
            <p id="todaysDate" class="app-date"></p>
            <div id="greeting" class="greeting"></div>
        </div>

        <div class="nav">
            <button class="nav-item active" onclick="showSection('dashboard', this)">Dashboard</button>
            <button class="nav-item" onclick="showSection('tracking', this)">Tracking</button>
            <button class="nav-item" onclick="showSection('exercises', this)">Exercises</button>
            <button class="nav-item" onclick="showSection('workouts', this)">Workouts</button>
            <button class="nav-item" onclick="showSection('plans', this)">Plans</button>
            <button class="nav-item" onclick="showSection('schedule', this)">Schedule</button>
            <button class="nav-item" onclick="showSection('goals', this)">Goals</button>
            <button class="nav-item" onclick="showSection('achievements', this)">Achievements</button>
            <button class="nav-item" onclick="showSection('measurements', this)">Progress</button>
        </div>

        <div class="content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalWorkouts">0</div>
                        <div class="stat-label">Completed Workouts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgSteps">0</div>
                        <div class="stat-label">Avg Steps (7 Days)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="currentWeight">0</div>
                        <div class="stat-label">Weight (kg)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weightChange">0</div>
                        <div class="stat-label">Weight Change</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìÖ Today's Workout</h3>
                    <div id="todaysWorkout">
                        <div class="empty-state">
                            <h4>No workout scheduled</h4>
                            <p>Create a plan and schedule to see today's workout here</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìä Weekly Progress</h3>
                    <div>
                        <label>Workouts This Week</label>
                        <div class="progress-bar">
                            <div class="progress-fill" id="workoutProgress" style="width: 0%"></div>
                        </div>
                        <span id="workoutProgressText">0 / 4 workouts</span>
                    </div>
                </div>
            </div>

            <!-- Exercise Library Section -->
            <div id="exercises" class="section">
                <div class="card">
                    <h3>üí™ Exercise Library</h3>
                    <div id="exerciseLibrary"></div>
                </div>
            </div>

            <!-- Workouts Section -->
            <div id="workouts" class="section">
                <div class="card">
                    <h3>üèãÔ∏è Create Workout</h3>
                    <div class="input-group">
                        <label>Workout Name</label>
                        <input type="text" id="workoutName" placeholder="Upper Body Strength">
                    </div>
                    <div class="input-group">
                        <label>Selected Exercises</label>
                        <div id="selectedExercises">
                            <p style="opacity: 0.6; font-size: 14px;">No exercises selected</p>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="openExerciseSelector()">Add Exercises</button>
                    <button class="btn" onclick="saveWorkout()">Save Workout</button>
                </div>

                <div class="card">
                    <h3>üìù My Workouts</h3>
                    <div id="workoutsList">
                        <div class="empty-state">
                            <h4>No workouts created</h4>
                            <p>Create your first workout above!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Plans Section -->
            <div id="plans" class="section">
                <div class="card">
                    <h3>üìã Create Plan</h3>
                    <div class="input-group">
                        <label>Plan Name</label>
                        <input type="text" id="planName" placeholder="6-Week Upper/Lower Split">
                    </div>
                    <div class="input-group">
                        <label>Description</label>
                        <textarea id="planDescription" placeholder="Body recomposition focused program..." rows="2"></textarea>
                    </div>
                    <div class="input-group">
                        <label>Duration (weeks)</label>
                        <input type="number" id="planDuration" placeholder="6" min="1" max="52">
                    </div>
                    <button class="btn" onclick="savePlan()">Create Plan</button>
                </div>

                <div class="card">
                    <h3>üìö My Plans</h3>
                    <div id="plansList">
                        <div class="empty-state">
                            <h4>No plans created</h4>
                            <p>Create your first training plan above!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goals Section -->
            <div id="goals" class="section">
                <div class="card">
                    <h3>üéØ Set Your Goals</h3>
                    <div class="input-group">
                        <label>Daily Steps Goal</label>
                        <input type="number" id="stepsGoal" placeholder="10000" min="1000" step="500">
                    </div>
                    <div class="input-group">
                        <label>Daily Water Goal (Liters)</label>
                        <input type="number" id="waterGoal" placeholder="2.5" min="1" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Daily Calories Goal</label>
                        <input type="number" id="caloriesGoal" placeholder="2000" min="1200" step="50">
                    </div>
                    <div class="input-group">
                        <label>Target Weight (kg)</label>
                        <input type="number" id="weightGoal" placeholder="70" min="40" step="0.5">
                    </div>
                    <button class="btn" onclick="saveGoals()">Save Goals</button>
                </div>

                <div class="card">
                    <h3>üìä Daily Goals Progress</h3>
                    <div id="dailyGoalsProgress">
                        <div class="empty-state">
                            <h4>Set goals above to see your progress</h4>
                            <p>Track how you're doing against your daily targets</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìà Steps Chart (Last 14 Days)</h3>
                    <div id="stepsChart" class="chart-container">
                        <div class="empty-state">
                            <h4>No steps data yet</h4>
                            <p>Start tracking to see your progress chart</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üíß Water Chart (Last 14 Days)</h3>
                    <div id="waterChart" class="chart-container">
                        <div class="empty-state">
                            <h4>No water data yet</h4>
                            <p>Start tracking to see your hydration chart</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üî• Calories Chart (Last 14 Days)</h3>
                    <div id="caloriesChart" class="chart-container">
                        <div class="empty-state">
                            <h4>No calories data yet</h4>
                            <p>Start tracking to see your tracking chart</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>‚öñÔ∏è Weight Progress Chart</h3>
                    <div id="weightChart" class="chart-container">
                        <div class="empty-state">
                            <h4>No weight data yet</h4>
                            <p>Take measurements to see your weight trend</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements Section -->
            <div id="achievements" class="section">
                <div class="card">
                    <h3>üèÜ Your Achievements</h3>
                    <div id="achievementStats" class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalAchievements">0</div>
                            <div class="stat-label">Unlocked</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="achievementProgress">0%</div>
                            <div class="stat-label">Progress</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üåü Workout Achievements</h3>
                    <div id="workoutAchievements"></div>
                </div>

                <div class="card">
                    <h3>üìä Progress Achievements</h3>
                    <div id="progressAchievements"></div>
                </div>

                <div class="card">
                    <h3>üî• Consistency Achievements</h3>
                    <div id="consistencyAchievements"></div>
                </div>
            </div>

            <!-- Schedule Section -->
            <div id="schedule" class="section">
                <div class="card">
                    <h3>üìÖ Weekly Schedule</h3>
                    <div class="input-group">
                        <label>Select Plan to Schedule</label>
                        <select id="planToSchedule">
                            <option value="">Select a plan...</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Start Date</label>
                        <input type="date" id="scheduleStartDate">
                    </div>
                    <div id="weeklySchedule"></div>
                    <button class="btn" onclick="saveSchedule()">Save Schedule</button>
                </div>

                <div class="card">
                    <h3>üìÜ Current Schedule</h3>
                    <div id="currentSchedule">
                        <div class="empty-state">
                            <h4>No active schedule</h4>
                            <p>Create and schedule a plan above!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tracking Section -->
            <div id="tracking" class="section">
                <div class="card">
                    <h3>üçé Daily Tracking</h3>
                    <div class="input-group">
                        <label>Date</label>
                        <input type="date" id="trackingDate">
                    </div>
                    <div class="stats-grid">
                        <div class="input-group">
                            <label>Calories</label>
                            <input type="number" id="calories" placeholder="2000" min="0" step="50">
                        </div>
                        <div class="input-group">
                            <label>Protein (g)</label>
                            <input type="number" id="protein" placeholder="150" min="0" step="5">
                        </div>
                        <div class="input-group">
                            <label>Water (L)</label>
                            <input type="number" id="water" placeholder="2.5" min="0" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Steps</label>
                            <input type="number" id="dailySteps" placeholder="8000" min="0" step="100">
                        </div>
                    </div>
                    <button class="btn" onclick="saveTracking()">Save Daily Data</button>
                </div>

                <div class="card">
                    <h3>üìä Daily Tracking History</h3>
                    <div id="dailyTrackingHistory">
                        <div class="empty-state">
                            <h4>No daily data yet</h4>
                            <p>Start tracking your daily metrics above!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Measurements Section -->
            <div id="measurements" class="section">
                <div class="card">
                    <h3>üìè Body Measurements</h3>
                    <div class="input-group">
                        <label>Date</label>
                        <input type="date" id="measurementDate">
                    </div>
                    <div class="stats-grid">
                        <div class="input-group">
                            <label>Weight (kg)</label>
                            <input type="number" id="weight" placeholder="70.5" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Body Fat %</label>
                            <input type="number" id="bodyFat" placeholder="15" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Muscle Mass (kg)</label>
                            <input type="number" id="muscleMass" placeholder="60" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Waist (cm)</label>
                            <input type="number" id="waist" placeholder="80" step="0.5">
                        </div>
                    </div>
                    <button class="btn" onclick="saveMeasurements()">Save Measurements</button>
                </div>

                <div class="card">
                    <h3>üìä All Measurements</h3>
                    <div id="progressHistory">
                        <div class="empty-state">
                            <h4>No measurements yet</h4>
                            <p>Take your first measurements above!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exercise Selection Modal -->
    <div id="exerciseModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeExerciseSelector()">&times;</span>
            <h3>Select Exercises</h3>
            <div class="filter-tabs" style="margin-bottom: 16px;">
                <div class="filter-tab active" onclick="filterModalExercises('all')">All</div>
                <div class="filter-tab" onclick="filterModalExercises('chest')">Chest</div>
                <div class="filter-tab" onclick="filterModalExercises('back')">Back</div>
                <div class="filter-tab" onclick="filterModalExercises('shoulders')">Shoulders</div>
                <div class="filter-tab" onclick="filterModalExercises('arms')">Arms</div>
                <div class="filter-tab" onclick="filterModalExercises('legs')">Legs</div>
                <div class="filter-tab" onclick="filterModalExercises('core')">Core</div>
            </div>
            <div id="modalExerciseGrid" class="exercise-grid"></div>
            <button class="btn" onclick="confirmExerciseSelection()">Add Selected Exercises</button>
        </div>
    </div>

    <script>
        // Register service worker file
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/claude-fitness-tracker/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
        
        // Data storage
        let workouts = JSON.parse(window.localStorage?.getItem('fittrack-workouts') || '[]');
        if (!Array.isArray(workouts)) workouts = [];
        
        let plans = JSON.parse(window.localStorage?.getItem('fittrack-plans') || '[]');
        if (!Array.isArray(plans)) plans = [];
        
        let schedule = JSON.parse(window.localStorage?.getItem('fittrack-schedule') || '{}');
        if (typeof schedule !== 'object' || schedule === null || Array.isArray(schedule)) {
            schedule = {};
        }
        
        let tracking = JSON.parse(window.localStorage?.getItem('fittrack-tracking') || '[]');
        if (!Array.isArray(tracking)) tracking = [];
        
        let measurements = JSON.parse(window.localStorage?.getItem('fittrack-measurements') || '[]');
        if (!Array.isArray(measurements)) measurements = [];
        
        let achievements = JSON.parse(window.localStorage?.getItem('fittrack-achievements') || '[]');
        if (!Array.isArray(achievements)) achievements = [];
        
        let workoutCompletions = JSON.parse(window.localStorage?.getItem('fittrack-completions') || '[]');
        if (!Array.isArray(workoutCompletions)) workoutCompletions = [];
        
        let goals = JSON.parse(window.localStorage?.getItem('fittrack-goals') || '[]');
        if (!Array.isArray(goals)) goals = [];

        let selectedExercises = [];
        let currentFilter = 'all';

        // Achievement definitions
        const achievementDefinitions = [
            // Workout Achievements
            {
                id: 'first_workout',
                name: 'Getting Started',
                description: 'Complete your first workout',
                icon: 'üéØ',
                category: 'workout',
                check: () => workoutCompletions.length >= 1
            },
            {
                id: 'workout_5',
                name: 'Momentum Builder',
                description: 'Complete 5 workouts',
                icon: 'üí™',
                category: 'workout',
                check: () => workoutCompletions.length >= 5
            },
            {
                id: 'workout_10',
                name: 'Dedicated',
                description: 'Complete 10 workouts',
                icon: 'üî•',
                category: 'workout',
                check: () => workoutCompletions.length >= 10
            },
            {
                id: 'workout_25',
                name: 'Fitness Enthusiast',
                description: 'Complete 25 workouts',
                icon: '‚≠ê',
                category: 'workout',
                check: () => workoutCompletions.length >= 25
            },
            {
                id: 'workout_50',
                name: 'Iron Will',
                description: 'Complete 50 workouts',
                icon: 'üèÜ',
                category: 'workout',
                check: () => workoutCompletions.length >= 50
            },
            
            // Progress Achievements
            {
                id: 'first_measurement',
                name: 'Baseline Set',
                description: 'Take your first body measurements',
                icon: 'üìè',
                category: 'progress',
                check: () => measurements.length >= 1
            },
            {
                id: 'weight_tracked',
                name: 'Scale Master',
                description: 'Track weight for 5 different days',
                icon: '‚öñÔ∏è',
                category: 'progress',
                check: () => measurements.length >= 5
            },
            {
                id: 'body_recomp',
                name: 'Body Recomposition',
                description: 'Track both weight and body fat percentage',
                icon: 'üìä',
                category: 'progress',
                check: () => measurements.some(m => m.weight > 0 && m.bodyFat > 0)
            },
            {
                id: 'progress_month',
                name: 'Monthly Tracker',
                description: 'Track progress for 30 days',
                icon: 'üìÖ',
                category: 'progress',
                check: () => {
                    if (measurements.length === 0) return false;
                    const firstDate = new Date(Math.min(...measurements.map(m => new Date(m.date))));
                    const daysDiff = (new Date() - firstDate) / (1000 * 60 * 60 * 24);
                    return daysDiff >= 30;
                }
            },
            
            // Consistency Achievements
            {
                id: 'daily_logger',
                name: 'Daily Logger',
                description: 'Track nutrition for 7 consecutive days',
                icon: 'üçé',
                category: 'consistency',
                check: () => {
                    if (tracking.length < 7) return false;
                    const sorted = tracking.sort((a, b) => new Date(b.date) - new Date(a.date));
                    for (let i = 0; i < 7; i++) {
                        const expectedDate = new Date();
                        expectedDate.setDate(expectedDate.getDate() - i);
                        const dateStr = expectedDate.toISOString().split('T')[0];
                        if (!sorted.find(n => n.date === dateStr)) return false;
                    }
                    return true;
                }
            },
            {
                id: 'step_crusher',
                name: 'Step Crusher',
                description: 'Hit 10,000+ steps in a day',
                icon: 'üëü',
                category: 'consistency',
                check: () => tracking.some(n => n.steps >= 10000)
            },
            {
                id: 'hydration_hero',
                name: 'Hydration Hero',
                description: 'Drink 3+ liters of water in a day',
                icon: 'üíß',
                category: 'consistency',
                check: () => tracking.some(n => n.water >= 3.0)
            },
            {
                id: 'protein_power',
                name: 'Protein Power',
                description: 'Hit 150g+ protein in a day',
                icon: 'ü•©',
                category: 'consistency',
                check: () => tracking.some(n => n.protein >= 150)
            },
            {
                id: 'workout_streak_7',
                name: 'Weekly Warrior',
                description: 'Complete workouts 7 days in a row',
                icon: 'üî•',
                category: 'consistency',
                check: () => {
                    if (workoutCompletions.length < 7) return false;
                    const sorted = workoutCompletions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    for (let i = 0; i < 7; i++) {
                        const expectedDate = new Date();
                        expectedDate.setDate(expectedDate.getDate() - i);
                        const dateStr = expectedDate.toISOString().split('T')[0];
                        if (!sorted.find(w => w.date === dateStr)) return false;
                    }
                    return true;
                }
            }
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todaysDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('trackingDate').value = today;
            document.getElementById('measurementDate').value = today;
            document.getElementById('scheduleStartDate').value = today;
            
            //exercises = exerciseDatabase; no longer needed; exercises now coming from exercises.js file
            loadData();
            loadGoals();
            updateAllDisplays();
            showGreeting();
        });

        // Navigation
        function showSection(sectionName, clickedButton) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Add active to clicked nav item
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            // Update displays for specific sections that need refresh
            if (sectionName === 'exercises') {
                displayExerciseLibrary();
            } else if (sectionName === 'workouts') {
                updateWorkoutsList();
            } else if (sectionName === 'plans') {
                updatePlansList();
            } else if (sectionName === 'schedule') {
                updateCurrentSchedule();
            } else if (sectionName === 'goals') {
                updateGoalsDisplay();
                updateChartsDisplay();
            } else if (sectionName === 'achievements') {
                updateAchievementsDisplay();
            } else if (sectionName === 'tracking') { 
                updateDailyTrackingHistory(); 
            } else if (sectionName === 'measurements') {
                updateProgressHistory();
                // updateWeightProgress(); not needed as took out chart on Progress page
            }
        }

        // Exercise Library Functions
        function displayExerciseLibrary() {
            const container = document.getElementById('exerciseLibrary');
            container.innerHTML = '';
            
            // Create filters
            const allMuscles = [...new Set(exercises.map(ex => ex.primaryMuscle))];
            const filterContainer = document.createElement('div');
            filterContainer.className = 'filter-tabs';
            filterContainer.innerHTML = `
                <span class="filter-tab active" data-filter="all">All</span>
                ${allMuscles.map(muscle => `<span class="filter-tab" data-filter="${muscle}">${muscle}</span>`).join('')}
            `;
            container.appendChild(filterContainer);
            
            // Add event listeners for filters
            filterContainer.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    filterContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    
                    const items = container.querySelectorAll('.exercise-item');
                    items.forEach(item => {
                        if (filter === 'all' || item.dataset.muscle === filter) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            });
        
            exercises.forEach(exercise => {
                const item = document.createElement('div');
                item.className = 'exercise-item';
                item.dataset.muscle = exercise.primaryMuscle;
                item.dataset.id = exercise.id;
                item.innerHTML = `
                    <div class="exercise-details">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="exercise-muscle">
                            ${exercise.primaryMuscle}
                            ${exercise.secondaryMuscles && exercise.secondaryMuscles.length > 0 ? ` + ${exercise.secondaryMuscles.join(', ')}` : ''}
                        </div>
                    </div>
                    <div class="exercise-equipment">
                        ${exercise.equipment}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function filterExercises(muscle) {
            currentFilter = muscle;
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            displayExerciseLibrary();
        }

        // Exercise Selection Modal
        function openExerciseSelector() {
            document.getElementById('exerciseModal').classList.add('active');
            displayModalExercises();
        }

        function closeExerciseSelector() {
            document.getElementById('exerciseModal').classList.remove('active');
        }

        function displayModalExercises() {
            const container = document.getElementById('modalExerciseGrid');
            const filteredExercises = currentFilter === 'all' ? 
                exercises : exercises.filter(ex => ex.muscle === currentFilter);
            
            container.innerHTML = filteredExercises.map(exercise => `
                <div class="exercise-item ${selectedExercises.find(e => e.id === exercise.id) ? 'selected' : ''}" 
                     onclick="toggleExerciseSelection(${exercise.id})">
                    <div class="exercise-details">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="exercise-muscle">${exercise.muscle} ‚Ä¢ ${exercise.equipment}</div>
                    </div>
                </div>
            `).join('');
        }

        function filterModalExercises(muscle) {
            currentFilter = muscle;
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            displayModalExercises();
        }

        function toggleExerciseSelection(exerciseId) {
            const exercise = exercises.find(e => e.id === exerciseId);
            const existingIndex = selectedExercises.findIndex(e => e.id === exerciseId);
            
            if (existingIndex >= 0) {
                selectedExercises.splice(existingIndex, 1);
            } else {
                selectedExercises.push({
                    ...exercise,
                    sets: 3,
                    reps: 10,
                    weight: 0
                });
            }
            
            displayModalExercises();
            updateSelectedExercisesDisplay();
        }

        function confirmExerciseSelection() {
            closeExerciseSelector();
            updateSelectedExercisesDisplay();
        }

        function updateSelectedExercisesDisplay() {
            const container = document.getElementById('selectedExercises');
            
            if (selectedExercises.length === 0) {
                container.innerHTML = '<p style="opacity: 0.6; font-size: 14px;">No exercises selected</p>';
                return;
            }
            
            container.innerHTML = selectedExercises.map((exercise, index) => `
                <div class="exercise-item">
                    <div class="exercise-details">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="set-inputs">
                            <input type="number" placeholder="Sets" value="${exercise.sets}" 
                                   onchange="updateExerciseParam(${index}, 'sets', this.value)">
                            <input type="number" placeholder="Reps" value="${exercise.reps}"
                                   onchange="updateExerciseParam(${index}, 'reps', this.value)">
                            <input type="number" placeholder="Weight" value="${exercise.weight}"
                                   onchange="updateExerciseParam(${index}, 'weight', this.value)">
                        </div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeSelectedExercise(${index})">√ó</button>
                </div>
            `).join('');
        }

        function updateExerciseParam(index, param, value) {
            selectedExercises[index][param] = parseFloat(value) || 0;
        }

        function removeSelectedExercise(index) {
            selectedExercises.splice(index, 1);
            updateSelectedExercisesDisplay();
        }

        // Workout Management
        function saveWorkout() {
            const name = document.getElementById('workoutName').value;
            
            if (!name || selectedExercises.length === 0) {
                alert('Please enter a workout name and select exercises');
                return;
            }
            
            const workout = {
                id: Date.now(),
                name: name,
                exercises: [...selectedExercises],
                created: new Date().toISOString()
            };
            
            workouts.push(workout);
            saveData();
            
            // Clear form
            document.getElementById('workoutName').value = '';
            selectedExercises = [];
            updateSelectedExercisesDisplay();
            updateWorkoutsList();
            updateDashboard();
            
            alert('Workout saved successfully!');
        }

        function deleteWorkout(id) {
            if (confirm('Delete this workout?')) {
                workouts = workouts.filter(w => w.id !== id);
                saveData();
                updateWorkoutsList();
                updateDashboard();
            }
        }

        function updateWorkoutsList() {
            const container = document.getElementById('workoutsList');
            
            if (workouts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>No workouts created</h4>
                        <p>Create your first workout above!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = workouts.map(workout => `
                <div class="workout-item">
                    <div class="workout-header">
                        <div class="workout-name">${workout.name}</div>
                        <button class="btn btn-danger btn-small" onclick="deleteWorkout(${workout.id})">Delete</button>
                    </div>
                    <div class="workout-exercises">
                        ${workout.exercises.map(ex => 
                            `${ex.name}: ${ex.sets}x${ex.reps}${ex.weight > 0 ? ' @' + ex.weight + 'kg' : ''}`
                        ).join(' ‚Ä¢ ')}
                    </div>
                </div>
            `).join('');
        }

        // Plan Management
        function savePlan() {
            const name = document.getElementById('planName').value;
            const description = document.getElementById('planDescription').value;
            const duration = parseInt(document.getElementById('planDuration').value);
            
            if (!name || !duration) {
                alert('Please enter plan name and duration');
                return;
            }
            
            const plan = {
                id: Date.now(),
                name: name,
                description: description,
                duration: duration,
                workouts: {},
                created: new Date().toISOString()
            };
            
            plans.push(plan);
            saveData();
            
            // Clear form
            document.getElementById('planName').value = '';
            document.getElementById('planDescription').value = '';
            document.getElementById('planDuration').value = '';
            
            updatePlansList();
            updatePlanSelector();
            updateDashboard();
            
            alert('Plan created successfully!');
        }

        function deletePlan(id) {
            if (confirm('Delete this plan?')) {
                plans = plans.filter(p => p.id !== id);
                saveData();
                updatePlansList();
                updatePlanSelector();
                updateDashboard();
            }
        }

        function updatePlansList() {
            const container = document.getElementById('plansList');
            
            if (plans.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>No plans created</h4>
                        <p>Create your first training plan above!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = plans.map(plan => `
                <div class="plan-item">
                    <div class="workout-header">
                        <div>
                            <div class="workout-name">${plan.name}</div>
                            <div class="workout-exercises">${plan.description}</div>
                            <div class="workout-exercises">${plan.duration} weeks</div>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deletePlan(${plan.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function updatePlanSelector() {
            const selector = document.getElementById('planToSchedule');
            selector.innerHTML = '<option value="">Select a plan...</option>' + 
                plans.map(plan => `<option value="${plan.id}">${plan.name}</option>`).join('');
        }

        // Schedule Management
        function generateWeeklySchedule() {
            const planId = document.getElementById('planToSchedule').value;
            if (!planId) return;
            
            const container = document.getElementById('weeklySchedule');
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            container.innerHTML = `
                <label>Assign Workouts to Days</label>
                <div class="schedule-grid">
                    ${days.map(day => `
                        <div class="day-card" onclick="selectDayForWorkout('${day}')">
                            <div class="day-name">${day}</div>
                            <select id="workout-${day}" style="width: 100%; font-size: 10px; padding: 4px;">
                                <option value="">Rest</option>
                                ${workouts.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                            </select>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function saveSchedule() {
            const planId = document.getElementById('planToSchedule').value;
            const startDate = document.getElementById('scheduleStartDate').value;
            
            if (!planId || !startDate) {
                alert('Please select a plan and start date');
                return;
            }
            
            const plan = plans.find(p => p.id === parseInt(planId));
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const weekSchedule = {};
            
            days.forEach(day => {
                const workoutId = document.getElementById(`workout-${day}`)?.value;
                if (workoutId) {
                    weekSchedule[day] = parseInt(workoutId);
                }
            });
            
            schedule = {
                planId: parseInt(planId),
                planName: plan.name,
                startDate: startDate,
                duration: plan.duration,
                weekSchedule: weekSchedule
            };
            
            saveData();
            updateCurrentSchedule();
            updateTodaysWorkout();
            
            alert('Schedule saved successfully!');
        }

        function updateCurrentSchedule() {
            const container = document.getElementById('currentSchedule');
            
            if (!schedule.planName) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>No active schedule</h4>
                        <p>Create and schedule a plan above!</p>
                    </div>
                `;
                return;
            }
            
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            container.innerHTML = `
                <div class="workout-item">
                    <div class="workout-name">${schedule.planName}</div>
                    <div class="workout-exercises">Started: ${new Date(schedule.startDate).toLocaleDateString()}</div>
                    <div class="workout-exercises">${schedule.duration} weeks</div>
                </div>
                <div class="schedule-grid">
                    ${days.map(day => {
                        const workoutId = schedule.weekSchedule[day];
                        const workout = workoutId ? workouts.find(w => w.id === workoutId) : null;
                        return `
                            <div class="day-card">
                                <div class="day-name">${day}</div>
                                <div class="day-workout">${workout ? workout.name : 'Rest'}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function updateTodaysWorkout() {
            const container = document.getElementById('todaysWorkout');
            
            if (!schedule.planName) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>No workout scheduled</h4>
                        <p>Create a plan and schedule to see today's workout here</p>
                    </div>
                `;
                return;
            }
            
            const today = new Date();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const todayName = dayNames[today.getDay()];
            const todayShort = todayName === 'Sun' ? 'Sun' : todayName;
            
            const workoutId = schedule.weekSchedule[todayShort];
            const workout = workoutId ? workouts.find(w => w.id === workoutId) : null;
            
            if (!workout) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>Rest Day</h4>
                        <p>No workout scheduled for today</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="workout-item">
                    <div class="workout-name">${workout.name}</div>
                    <div class="workout-exercises">
                        ${workout.exercises.map(ex => 
                            `${ex.name}: ${ex.sets}x${ex.reps}${ex.weight > 0 ? ' @' + ex.weight + 'kg' : ''}`
                        ).join('<br>')}
                    </div>
                    <button class="btn btn-small" onclick="logWorkoutCompletion()">Mark as Completed</button>
                </div>
            `;
        }

        function logWorkoutCompletion() {
            const today = new Date().toISOString().split('T')[0];
            
            // Don't log duplicate completions for the same day
            if (workoutCompletions.find(w => w.date === today)) {
                alert('Workout already marked as completed for today!');
                return;
            }
            
            const todayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][new Date().getDay()];
            const todayShort = todayName === 'Sun' ? 'Sun' : todayName;
            const workoutId = schedule.weekSchedule?.[todayShort];
            const workout = workoutId ? workouts.find(w => w.id === workoutId) : null;
            
            workoutCompletions.push({
                id: Date.now(),
                date: today,
                workoutId: workoutId,
                workoutName: workout?.name || 'Workout'
            });
            
            saveData();
            checkAchievements();
            updateDashboard();
            showWorkoutReminder(); // Refresh reminder
            
            alert('üéâ Workout completed! Great job!');
        }

        // Achievement System
        function checkAchievements() {
            let newAchievements = [];
            
            achievementDefinitions.forEach(def => {
                // Check if already unlocked
                if (achievements.find(a => a.id === def.id)) return;
                
                // Check if conditions are met
                if (def.check()) {
                    const achievement = {
                        ...def,
                        unlockedDate: new Date().toISOString(),
                        isNew: true
                    };
                    achievements.push(achievement);
                    newAchievements.push(achievement);
                }
            });
            
            if (newAchievements.length > 0) {
                saveData();
                showNewAchievements(newAchievements);
                updateAchievementsDisplay();
            }
        }

        function showNewAchievements(newAchievements) {
            const card = document.getElementById('recentAchievementCard');
            const content = document.getElementById('recentAchievement');
            
            if (newAchievements.length === 1) {
                const achievement = newAchievements[0];
                content.innerHTML = `
                    <div class="achievement-item unlocked">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-info">
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-description">${achievement.description}</div>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="workout-item">
                        <div class="workout-name">üéâ ${newAchievements.length} New Achievements!</div>
                        <div class="workout-exercises">
                            ${newAchievements.map(a => `${a.icon} ${a.name}`).join(' ‚Ä¢ ')}
                        </div>
                    </div>
                `;
            }
            
            card.classList.add('new-achievement-card');
            card.style.display = 'block';
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                card.style.display = 'none';
                card.classList.remove('new-achievement-card');
                // Mark achievements as no longer new
                achievements.forEach(a => a.isNew = false);
                saveData();
            }, 10000);
        }

        function updateAchievementsDisplay() {
            // Update stats
            const unlockedCount = achievements.length;
            const totalCount = achievementDefinitions.length;
            const progressPercent = Math.round((unlockedCount / totalCount) * 100);
            
            document.getElementById('totalAchievements').textContent = `${unlockedCount}/${totalCount}`;
            document.getElementById('achievementProgress').textContent = `${progressPercent}%`;
            
            // Update achievement lists by category
            updateAchievementCategory('workout', 'workoutAchievements');
            updateAchievementCategory('progress', 'progressAchievements');
            updateAchievementCategory('consistency', 'consistencyAchievements');
        }

        function updateAchievementCategory(category, containerId) {
            const container = document.getElementById(containerId);
            const categoryAchievements = achievementDefinitions.filter(def => def.category === category);
            
            container.innerHTML = categoryAchievements.map(def => {
                const unlocked = achievements.find(a => a.id === def.id);
                const unlockedClass = unlocked ? 'unlocked' : '';
                const unlockedDate = unlocked ? 
                    `<div class="achievement-date">Unlocked: ${new Date(unlocked.unlockedDate).toLocaleDateString()}</div>` : '';
                
                return `
                    <div class="achievement-item ${unlockedClass}">
                        <div class="achievement-icon">${def.icon}</div>
                        <div class="achievement-info">
                            <div class="achievement-name">${def.name}</div>
                            <div class="achievement-description">${def.description}</div>
                            ${unlockedDate}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Goals Management
        function saveGoals() {
            goals = {
                steps: parseInt(document.getElementById('stepsGoal').value) || 0,
                water: parseFloat(document.getElementById('waterGoal').value) || 0,
                calories: parseInt(document.getElementById('caloriesGoal').value) || 0,
                weight: parseFloat(document.getElementById('weightGoal').value) || 0
            };
            
            saveData();
            checkAchievements(); // Check for goal-related achievements
            updateGoalsDisplay();
            updateChartsDisplay();
            updateDashboard();
            
            alert('Goals saved successfully!');
        }

        function loadGoals() {
            if (goals.steps) document.getElementById('stepsGoal').value = goals.steps;
            if (goals.water) document.getElementById('waterGoal').value = goals.water;
            if (goals.calories) document.getElementById('caloriesGoal').value = goals.calories;
            if (goals.weight) document.getElementById('weightGoal').value = goals.weight;
        }

        function updateGoalsDisplay() {
            const container = document.getElementById('dailyGoalsProgress');
            
            if (!goals.steps && !goals.water && !goals.calories && !goals.weight) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>Set goals above to see your progress</h4>
                        <p>Track how you're doing against your daily targets</p>
                    </div>
                `;
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const todayData = tracking.find(n => n.date === today) || {};
            const todayWeight = measurements.find(m => m.date === today);

            let progressItems = [];

            if (goals.steps) {
                const current = todayData.steps || 0;
                const progress = Math.min((current / goals.steps) * 100, 100);
                const status = current >= goals.steps ? 'achieved' : 
                             current >= goals.steps * 0.8 ? 'close' : 'needs-work';
                const statusText = current >= goals.steps ? 'Achieved!' : 
                                 current >= goals.steps * 0.8 ? 'Close!' : 'Keep going!';
                
                progressItems.push(`
                    <div class="goal-progress-item ${status}">
                        <div class="goal-header">
                            <div class="goal-name">üëü Steps: ${current.toLocaleString()} / ${goals.steps.toLocaleString()}</div>
                            <div class="goal-status ${status}">${statusText}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `);
            }

            if (goals.water) {
                const current = todayData.water || 0;
                const progress = Math.min((current / goals.water) * 100, 100);
                const status = current >= goals.water ? 'achieved' : 
                             current >= goals.water * 0.8 ? 'close' : 'needs-work';
                const statusText = current >= goals.water ? 'Achieved!' : 
                                 current >= goals.water * 0.8 ? 'Close!' : 'Keep going!';
                
                progressItems.push(`
                    <div class="goal-progress-item ${status}">
                        <div class="goal-header">
                            <div class="goal-name">üíß Water: ${current}L / ${goals.water}L</div>
                            <div class="goal-status ${status}">${statusText}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `);
            }

            if (goals.calories) {
                const current = todayData.calories || 0;
                const progress = Math.min((current / goals.calories) * 100, 100);
                const status = current >= goals.calories ? 'achieved' : 
                             current >= goals.calories * 0.8 ? 'close' : 'needs-work';
                const statusText = current >= goals.calories ? 'Achieved!' : 
                                 current >= goals.calories * 0.8 ? 'Close!' : 'Keep going!';
                
                progressItems.push(`
                    <div class="goal-progress-item ${status}">
                        <div class="goal-header">
                            <div class="goal-name">üî• Calories: ${current} / ${goals.calories}</div>
                            <div class="goal-status ${status}">${statusText}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `);
            }

            if (goals.weight && todayWeight) {
                const current = todayWeight.weight;
                const diff = Math.abs(current - goals.weight);
                const status = diff <= 0.5 ? 'achieved' : diff <= 2 ? 'close' : 'needs-work';
                const statusText = diff <= 0.5 ? 'At goal!' : diff <= 2 ? 'Close!' : 'Keep going!';
                
                progressItems.push(`
                    <div class="goal-progress-item ${status}">
                        <div class="goal-header">
                            <div class="goal-name">‚öñÔ∏è Weight: ${current}kg / ${goals.weight}kg</div>
                            <div class="goal-status ${status}">${statusText}</div>
                        </div>
                        <div style="opacity: 0.7; font-size: 14px;">
                            ${diff.toFixed(1)}kg ${current > goals.weight ? 'above' : 'below'} target
                        </div>
                    </div>
                `);
            }

            container.innerHTML = progressItems.join('');
        }

        // Chart Generation Functions
        function updateChartsDisplay() {
            // Steps Chart
            const stepsData = tracking.slice(-14).map(n => n.steps);
            const stepsGoal = goals.steps;
            updateStepsChart(stepsData, stepsGoal);
            
            // Water Chart
            const waterData = tracking.slice(-14).map(n => n.water);
            const waterGoal = goals.water;
            updateWaterChart(waterData, waterGoal);
            
            // Calories Chart
            const caloriesData = tracking.slice(-14).map(n => n.calories);
            const caloriesGoal = goals.calories;
            updateCaloriesChart(caloriesData, caloriesGoal);
        
            // Weight Chart
            const weightData = measurements.slice(-14).map(m => m.weight);
            const weightGoal = goals.weight;
            updateWeightChart(weightData, weightGoal);
        }

        function updateStepsChart(data, goal) {
            generateChart('stepsChart', data, goal);
        }
        
        function updateWaterChart(data, goal) {
            generateChart('waterChart', data, goal);
        }
        
        function updateCaloriesChart(data, goal) {
            generateChart('caloriesChart', data, goal);
        }
        
        function updateWeightChart() {
            const container = document.getElementById('weightChart');
            if (!container) return;
            
            const sortedMeasurements = [...measurements].sort((a, b) => new Date(a.date) - new Date(b.date));
            const data = sortedMeasurements.map(m => m.weight);
            
            generateChart('weightChart', data, goals.weight, 60);
        }

        function getLast14DaysData(field) {
            const data = [];
            for (let i = 13; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const dayData = tracking.find(n => n.date === dateStr);
                data.push({
                    date: dateStr,
                    value: dayData ? (dayData[field] || 0) : 0
                });
            }
            return data;
        }

        
        // Charting Functions
        function generateChart(containerId, data, goal, yMin = 0) {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <h4>No data yet</h4>
                    <p>Start tracking to see your progress chart</p>
                </div>`;
                return;
            }
        
            const margin = { top: 20, right: 20, bottom: 30, left: 40 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = 200 - margin.top - margin.bottom;
        
            // Clear previous chart
            container.innerHTML = '';
        
            // Create SVG and g
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
        
            const dataMax = Math.max(...data.filter(d => !isNaN(d) && d !== null));
            const goalMax = goal || 0;
            const yMax = Math.max(dataMax, goalMax) * 1.1;
        
            const xScale = d3.scalePoint()
                .domain(data.map((d, i) => i))
                .range([0, width]);
        
            const yScale = d3.scaleLinear()
                .domain([yMin, yMax])
                .range([height, 0]);
        
            const yTicks = d3.axisLeft(yScale)
                .ticks(5)
                .tickFormat(d => {
                    const num = Math.round(d);
                    return num > 1000 ? `${num / 1000}k` : num;
                });
        
            // Y-axis
            svg.append('g')
                .attr('class', 'chart-axis')
                .call(yTicks);
        
            // X-axis line
            svg.append('line')
                .attr('class', 'chart-axis')
                .attr('x1', 0)
                .attr('y1', height)
                .attr('x2', width)
                .attr('y2', height);
        
            // Goal Line
            if (goal) {
                // Draw the goal line
                svg.append('line')
                    .attr('class', 'goal-line')
                    .attr('x1', 0)
                    .attr('x2', width)
                    .attr('y1', yScale(goal))
                    .attr('y2', yScale(goal));
            
                // Add the label inside the chart
                svg.append('text')
                    .attr('x', width - 5) // 5px padding from right edge
                    .attr('y', yScale(goal) - 5) // 5px above the line
                    .attr('text-anchor', 'end') // align text to the right
                    .attr('class', 'goal-label')
                    .text(`Goal: ${goal}`);
            }

        
            // Data Line
            const line = d3.line()
                .x((d, i) => xScale(i))
                .y(d => yScale(d));
        
            svg.append('path')
                .datum(data)
                .attr('class', 'chart-line data-line')
                .attr('d', line);
        
            // Data points
            svg.selectAll('.chart-dot')
                .data(data)
                .enter().append('circle')
                .attr('class', d => `chart-dot ${d >= goal ? 'above-goal' : 'below-goal'}`)
                .attr('cx', (d, i) => xScale(i))
                .attr('cy', d => yScale(d))
                .attr('r', 4);
        }

        function showWorkoutReminder() {
            const today = new Date();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const todayName = dayNames[today.getDay()];
            const todayShort = todayName === 'Sun' ? 'Sun' : todayName;
        
            const card = document.getElementById('workoutReminderCard');
            const content = document.getElementById('workoutReminder');
        
            // Check if there's an active schedule
            if (!schedule.planName) {
                // Only try to hide the card if it exists
                if (card) {
                    card.style.display = 'none';
                }
                return;
            }
        
            // Check if workout is scheduled for today
            const workoutId = schedule.weekSchedule[todayShort];
            if (!workoutId) {
                // Only try to hide the card if it exists
                if (card) {
                    card.style.display = 'none';
                }
                return;
            }
        
            // Check if already completed today
            const todayStr = today.toISOString().split('T')[0];
            const alreadyCompleted = workoutCompletions.find(w => w.date === todayStr);
        
            if (alreadyCompleted) {
                content.innerHTML = `
                    <div class="workout-item">
                        <div class="workout-name">‚úÖ Today's workout completed!</div>
                        <div class="workout-exercises">Great job finishing "${alreadyCompleted.workoutName}"</div>
                    </div>
                `;
                if (card) {
                    card.classList.remove('reminder-card');
                }
            } else {
                const workout = workouts.find(w => w.id === workoutId);
                content.innerHTML = `
                    <div class="workout-item">
                        <div class="workout-name">‚è∞ Time to workout!</div>
                        <div class="workout-exercises">
                            You have "${workout?.name || 'Workout'}" scheduled for today
                        </div>
                        <button class="btn btn-small" onclick="logWorkoutCompletion()" style="margin-top: 8px;">
                            Mark as Completed
                        </button>
                    </div>
                `;
                if (card) {
                    card.classList.add('reminder-card');
                }
            }
            
            // Only try to show the card if it exists
            if (card) {
                card.style.display = 'block';
            }
        }
        function saveTracking() {
            const date = document.getElementById('trackingDate').value;
            const calories = document.getElementById('calories').value;
            const protein = document.getElementById('protein').value;
            const water = document.getElementById('water').value;
            const steps = document.getElementById('dailySteps').value;

            if (!date) {
                alert('Please select a date.');
                return;
            }

            const existingEntryIndex = tracking.findIndex(entry => entry.date === date);
        
            const newEntry = {
                date,
                calories: calories ? parseInt(calories) : 0,
                protein: protein ? parseInt(protein) : 0,
                water: water ? parseFloat(water) : 0,
                steps: steps ? parseInt(steps) : 0
            };

            if (existingEntryIndex !== -1) {
                tracking[existingEntryIndex] = newEntry;
            } else {
                tracking.push(newEntry);
                tracking.sort((a, b) => new Date(a.date) - new Date(b.date));
            }
        
            window.localStorage?.setItem('fittrack-tracking', JSON.stringify(tracking));
        
            // After saving, update all displays to reflect the new data
            updateAllDisplays();
            
            alert('Daily data saved!');
        }
        function updateDailyTrackingHistory() {
            const container = document.getElementById('dailyTrackingHistory');
            
            if (tracking.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>No daily data yet</h4>
                        <p>Start tracking your daily metrics above!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tracking.map(entry => `
                <div class="workout-item">
                    <div class="workout-header">
                        <div>
                            <div class="workout-name">${new Date(entry.date).toLocaleDateString()}</div>
                            <div class="workout-exercises">
                                üî• ${entry.calories} cal ‚Ä¢ ü•© ${entry.protein}g protein ‚Ä¢ üíß ${entry.water}L water ‚Ä¢ üëü ${entry.steps.toLocaleString()} steps
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Measurements Management
        function saveMeasurements() {
            // Always reload from localStorage first
            let weightValue = document.getElementById('weight').value;
            let weight = weightValue !== "" ? parseFloat(weightValue) : null;
            
            const measurement = {
                id: Date.now(),
                date: document.getElementById('measurementDate').value,
                weight: weight,
                bodyFat: parseFloat(document.getElementById('bodyFat').value) || null,
                muscleMass: parseFloat(document.getElementById('muscleMass').value) || null,
                waist: parseFloat(document.getElementById('waist').value) || null
            };
        
            if (!measurement.date) {
                alert('Please select a date');
                return;
            }
        
            // Remove any existing entry with the same date
            measurements = measurements.filter(m => m.date !== measurement.date);
        
            // Add the new one at the start
            measurements.unshift(measurement);
        
            // Save to localStorage
            window.localStorage.setItem('fittrack-measurements', JSON.stringify(measurements));
        
            // Update the global variable
            window.measurements = measurements;
        
            // Clear the form
            document.getElementById('weight').value = '';
            document.getElementById('bodyFat').value = '';
            document.getElementById('muscleMass').value = '';
            document.getElementById('waist').value = '';
        
            // Refresh displays
            updateProgressHistory();
            updateDashboard?.();
        
            alert('Measurements saved!');
        }

        function deleteMeasurement(id) {
            if (confirm('Are you sure you want to delete this measurement?')) {
                // Always reload from localStorage
                let measurements = JSON.parse(window.localStorage.getItem('fittrack-measurements') || '[]');
        
                // Find the index of the measurement to delete
                const index = measurements.findIndex(m => String(m.id) === String(id));
        
                if (index !== -1) {
                    measurements.splice(index, 1);
        
                    // Save updated array
                    window.localStorage.setItem('fittrack-measurements', JSON.stringify(measurements));
        
                    // Update the global variable too (if you have one)
                    window.measurements = measurements;
        
                    // Refresh displays
                    updateProgressHistory();
                    updateDashboard?.();
        
                    alert('Measurement deleted.');
                }
            }
        }

        function updateProgressHistory() {
            const container = document.getElementById('progressHistory');
            if (!container) return;
        
            // Always reload fresh data from localStorage
            let measurements = JSON.parse(window.localStorage.getItem('fittrack-measurements') || '[]');
        
            if (measurements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>No measurements yet</h4>
                        <p>Take your first measurements above!</p>
                    </div>
                `;
                return;
            }
        
            // Sort measurements by date (newest first)
            const sortedMeasurements = [...measurements].sort((a, b) => new Date(b.date) - new Date(a.date));
        
            container.innerHTML = sortedMeasurements.map(measurement => `
                <div class="workout-item">
                    <div class="workout-header">
                        <div>
                            <div class="workout-name">${new Date(measurement.date).toLocaleDateString()}</div>
                            <div class="workout-exercises">
                                ‚öñÔ∏è ${measurement.weight}kg ‚Ä¢ üìä ${measurement.bodyFat}% BF ‚Ä¢ üí™ ${measurement.muscleMass}kg muscle ‚Ä¢ üìè ${measurement.waist}cm waist
                            </div>
                        </div>
                        <button class="btn btn-small btn-danger" onclick="deleteMeasurement('${measurement.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                                <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        
            // Update global state so it‚Äôs consistent elsewhere
            window.measurements = measurements;
        }

        // Dashboard Updates
        function updateDashboard() {
            document.getElementById('totalWorkouts').textContent = workoutCompletions.length;
            
            // Average steps for the last 7 days
            const last7DaysTracking = tracking.slice(-7);
            const avgSteps = last7DaysTracking.length > 0 ? 
                Math.round(last7DaysTracking.reduce((sum, n) => sum + (n.steps || 0), 0) / last7DaysTracking.length) : 0;
            document.getElementById('avgSteps').textContent = avgSteps.toLocaleString();
            
            // Current weight and change
            if (measurements.length > 0) {
                const sortedMeasurements = [...measurements].sort((a, b) => new Date(a.date) - new Date(b.date));
                const latest = sortedMeasurements[sortedMeasurements.length - 1];
                document.getElementById('currentWeight').textContent = latest.weight;
                
                if (sortedMeasurements.length > 1) {
                    const earliest = sortedMeasurements[0];
                    const change = latest.weight - earliest.weight;
                    const changeText = change >= 0 ? `+${change.toFixed(1)}` : `${change.toFixed(1)}`;
                    document.getElementById('weightChange').textContent = changeText;
                    
                    const weightGoal = goals.find(g => g.type === 'weight');
                    
                    if (weightGoal) {
                        if (weightGoal.target < earliest.weight) {
                            document.getElementById('weightChange').style.color = change < 0 ? '#10b981' : '#ef4444';
                        } else if (weightGoal.target > earliest.weight) {
                            document.getElementById('weightChange').style.color = change > 0 ? '#10b981' : '#ef4444';
                        } else {
                            document.getElementById('weightChange').style.color = '#ffffff';
                        }
                    } else {
                        document.getElementById('weightChange').style.color = change >= 0 ? '#10b981' : '#ef4444';
                    }
                } else {
                    document.getElementById('weightChange').textContent = '0';
                }
            } else {
                document.getElementById('currentWeight').textContent = '0';
                document.getElementById('weightChange').textContent = '0';
            }
        
            // Update weekly progress (simplified)
            const progressPercent = Math.min((workouts.length * 10), 100);
            document.getElementById('workoutProgress').style.width = progressPercent + '%';
            document.getElementById('workoutProgressText').textContent = 
                `${workouts.length} workouts created`;
        }

        // Greeting
        function showGreeting() {
            const greetingEl = document.getElementById("greeting");
            if (!greetingEl) return;
        
            const now = new Date();
            const hour = now.getHours();
        
            let greetingText = "Hello";
            let emoji = "üëã";
        
            if (hour < 12) {
                greetingText = "Good morning";
                emoji = "üåÖ";
            } else if (hour < 18) {
                greetingText = "Good afternoon";
                emoji = "‚òÄÔ∏è";
            } else {
                greetingText = "Good evening";
                emoji = "üåô";
            }
        
            greetingEl.innerHTML = `<h2>${emoji} ${greetingText}, Barry!</h2>`;
        }

        
        // Data Management
        function saveData() {
            if (window.localStorage) {
                window.localStorage.setItem('fittrack-workouts', JSON.stringify(workouts));
                window.localStorage.setItem('fittrack-plans', JSON.stringify(plans));
                window.localStorage.setItem('fittrack-schedule', JSON.stringify(schedule));
                window.localStorage.setItem('fittrack-tracking', JSON.stringify(tracking));
                window.localStorage.setItem('fittrack-measurements', JSON.stringify(measurements));
                window.localStorage.setItem('fittrack-achievements', JSON.stringify(achievements));
                window.localStorage.setItem('fittrack-completions', JSON.stringify(workoutCompletions));
                window.localStorage.setItem('fittrack-goals', JSON.stringify(goals));
            }
        }

        function loadData() {
            // Data already loaded in initialization
        }

        window.onload = function() {
            showSection('dashboard', document.querySelector('.nav-item.active'));
            updateAllDisplays();
            showGreeting();
        };

        function updateAllDisplays() {
            displayExerciseLibrary();
            updateWorkoutsList();
            updatePlansList();
            updatePlanSelector();
            updateCurrentSchedule();
            updateTodaysWorkout();
            updateDailyTrackingHistory();
            updateProgressHistory();
            updateAchievementsDisplay();
            updateGoalsDisplay();
            updateChartsDisplay();
            showWorkoutReminder();
            updateDashboard();
            checkAchievements(); // Check achievements on app load
        }

        // Event Listeners
        document.getElementById('planToSchedule').addEventListener('change', generateWeeklySchedule);
    </script>
</body>
</html>
