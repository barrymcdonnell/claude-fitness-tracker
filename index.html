<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gluais - Movement For The Body</title>
    <meta name="theme-color" content="#6366f1">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="icon" href="images/favicon.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="exercises.js"></script>
</head>
<body>
    <div class="container">
        <header class="app-header">
          <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span>Barry</span>
          </div>
        
          <div class="header-icons">
            <i class="fas fa-search" title="Search"></i>
            <i class="fas fa-calendar-alt" title="Calendar"></i>
          </div>
        </header>


        <div id="update-banner" style="display: none; background: #28a745; color: white; padding: 10px; text-align: center; position: fixed; bottom: 0; width: 100%; z-index: 1000;">
          New version available! Click <a id="reload-link" href="#" style="color: white; font-weight: bold;">here</a> to update.
        </div>

        <div class="content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <!-- Challender reminder box -->
                <div id="challengeReminder" style="display:none;" class="reminder-box"></div>
                <!-- Grid cards for weight/workouts stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalWorkouts">0</div>
                        <div class="stat-label">Completed Workouts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgSteps">0</div>
                        <div class="stat-label">Avg Steps (7 Days)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="currentWeight">0</div>
                        <div class="stat-label">Weight (kg)</div>
                        <div id="bmiBadge"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weightChange">0</div>
                        <div class="stat-label">Weight Change</div>
                    </div>
                </div>

                <div class="card">
                    <h3>📅 Today's Workout</h3>
                    <div id="todaysWorkout">
                        <div class="empty-state">
                            <h4>No workout scheduled</h4>
                            <p>Create a plan and schedule to see today's workout here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exercise Library Section -->
            <div id="exercises" class="section">
                <div class="card">
                    <h3>💪 Exercise Library</h3>
                    <p id="exerciseCount" class="exercise-count"></p>
                    <div id="exerciseLibrary"></div>
                </div>
            </div>

            <!-- Workouts Section -->
            <div id="workouts" class="section">
                <div class="card">
                    <h3>🏋️ Create Workout</h3>
                    <div class="input-group">
                        <label>Workout Name</label>
                        <input type="text" id="workoutName" placeholder="Upper Body Strength">
                    </div>
                    <div class="input-group">
                        <label>Selected Exercises</label>
                        <div id="selectedExercises">
                            <p style="opacity: 0.6; font-size: 14px;">No exercises selected</p>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="openExerciseSelector()">Add Exercises</button>
                    <button class="btn-save" onclick="saveWorkout()">Save Workout</button>
                </div>

                <div class="card">
                    <h3>📝 My Workouts</h3>
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="upcoming" onclick="switchWorkoutTab(event)">Active (<span id="activeWorkoutCount">0</span>)</button>
                        <button class="tab-btn" data-tab="completed" onclick="switchWorkoutTab(event)">Completed</button>
                      </div>

                    <!-- Container for active workouts -->
                    <div id="workoutsTab-upcoming" class="tab-content">
                        <div id="workoutsList">
                            <div class="empty-state">
                                <h4>No workouts created</h4>
                                <p>Create your first workout above!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Container for completed workouts -->
                    <div id="workoutsTab-completed" class="tab-content" style="display:none;">
                        <div id="completedWorkoutsList" class="completed-workouts"></div>
                    </div>
                </div>
                
                <!-- Container for active workouts -->
                <div id="activeWorkoutContainer"></div>
            </div>

            <!-- Plans Section -->
            <div id="plans" class="section">
                <div class="card">
                    <h3>📋 Create Plan</h3>
                    <div class="input-group">
                        <label>Plan Name</label>
                        <input type="text" id="planName" placeholder="6-Week Upper/Lower Split">
                    </div>
                    <div class="input-group">
                        <label>Description</label>
                        <textarea id="planDescription" placeholder="Body recomposition focused program..." rows="2"></textarea>
                    </div>
                    <div class="input-group">
                        <label>Duration (weeks)</label>
                        <input type="number" id="planDuration" placeholder="6" min="1" max="52">
                    </div>
                    <button class="btn-save" onclick="savePlan()">Create Plan</button>
                </div>

                <div class="card">
                    <h3>📚 My Plans</h3>
                    <div id="plansList">
                        <div class="empty-state">
                            <h4>No plans created</h4>
                            <p>Create your first training plan above!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goals Section -->
            <div id="goals" class="section">
                <div class="card">
                    <h3>🎯 Set Your Goals</h3>
                    <div class="input-group">
                        <label>Daily Steps Goal</label>
                        <input type="number" id="stepsGoal" placeholder="10000" min="1000" step="500">
                    </div>
                    <div class="input-group">
                        <label>Daily Water Goal (Liters)</label>
                        <input type="number" id="waterGoal" placeholder="2.5" min="1" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Daily Calories Goal</label>
                        <input type="number" id="caloriesGoal" placeholder="2000" min="1200" step="50">
                    </div>
                    <div class="input-group">
                        <label>Target Weight (kg)</label>
                        <input type="number" id="weightGoal" placeholder="70" min="40" step="0.5">
                    </div>
                    <button class="btn-save" onclick="saveGoals()">Save Goals</button>
                </div>

                <div class="card">
                    <h3>📊 Daily Goals Progress</h3>
                    <div id="dailyGoalsProgress">
                        <div class="empty-state">
                            <h4>Set goals above to see your progress</h4>
                            <p>Track how you're doing against your daily targets</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>📈 Steps Chart (Last 14 Days)</h3>
                    <div id="stepsChart" class="chart-container">
                        <div class="empty-state">
                            <h4>No steps data yet</h4>
                            <p>Start tracking to see your progress chart</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>💧 Water Chart (Last 14 Days)</h3>
                    <div id="waterChart" class="chart-container">
                        <div class="empty-state">
                            <h4>No water data yet</h4>
                            <p>Start tracking to see your hydration chart</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>🔥 Calories Chart (Last 14 Days)</h3>
                    <div id="caloriesChart" class="chart-container">
                        <div class="empty-state">
                            <h4>No calories data yet</h4>
                            <p>Start tracking to see your tracking chart</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>⚖️ Weight Progress Chart</h3>
                    <div id="weightChart" class="chart-container">
                        <div class="empty-state">
                            <h4>No weight data yet</h4>
                            <p>Take measurements to see your weight trend</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements Section -->
            <div id="achievements" class="section">
                <div class="card">
                    <h3>🏆 Your Achievements</h3>
                    <div id="achievementStats" class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalAchievements">0</div>
                            <div class="stat-label">Unlocked</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="achievementProgress">0%</div>
                            <div class="stat-label">Progress</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>🌟 Workout Achievements</h3>
                    <div id="workoutAchievements"></div>
                </div>

                <div class="card">
                    <h3>📊 Progress Achievements</h3>
                    <div id="progressAchievements"></div>
                </div>

                <div class="card">
                    <h3>🔥 Consistency Achievements</h3>
                    <div id="consistencyAchievements"></div>
                </div>
            </div>

            <!-- Schedule Section -->
            <div id="schedule" class="section">
                <div class="card">
                    <h3>📅 Weekly Schedule</h3>
                    <div class="input-group">
                        <label>Select Plan to Schedule</label>
                        <select id="planToSchedule">
                            <option value="">Select a plan...</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Start Date</label>
                        <input type="date" id="scheduleStartDate">
                    </div>
                    <div id="weeklySchedule"></div>
                    <button class="btn-save" onclick="saveSchedule()">Save Schedule</button>
                </div>

                <div class="card">
                    <h3>📆 Current Schedule</h3>
                    <div id="currentSchedule">
                        <div class="empty-state">
                            <h4>No active schedule</h4>
                            <p>Create and schedule a plan above!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tracking Section -->
            <div id="tracking" class="section">
                <div class="card">
                    <h3>🍎 Daily Tracking</h3>
                    <div class="input-group">
                        <label>Date</label>
                        <input type="date" id="trackingDate">
                    </div>
                    <div class="stats-grid">
                        <div class="input-group">
                            <label>Calories</label>
                            <input type="number" id="calories" placeholder="2000" min="0" step="50">
                        </div>
                        <div class="input-group">
                            <label>Protein (g)</label>
                            <input type="number" id="protein" placeholder="150" min="0" step="5">
                        </div>
                        <div class="input-group">
                            <label>Water (L)</label>
                            <input type="number" id="water" placeholder="2.5" min="0" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Steps</label>
                            <input type="number" id="dailySteps" placeholder="8000" min="0" step="100">
                        </div>
                    </div>
                    <button class="btn-save" onclick="saveTracking()">Save Daily Data</button>
                </div>

                <div class="card">
                    <h3>📊 Daily Tracking History</h3>
                    <div id="dailyTrackingHistory">
                        <div class="empty-state">
                            <h4>No daily data yet</h4>
                            <p>Start tracking your daily metrics above!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Measurements Section -->
            <div id="measurements" class="section">
                <div class="card">
                    <h3>🏋️ Weight Volume</h3>
                    <!-- Show volume stats -->
                    <div id="volumeStats"></div>
                </div>
                <div class="card">
                    <h3>📏 Body Measurements</h3>
                    <div class="input-group">
                        <label>Date</label>
                        <input type="date" id="measurementDate">
                    </div>
                    <div class="stats-grid">
                        <div class="input-group">
                            <label>Weight (kg)</label>
                            <input type="number" id="weight" placeholder="70.5" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Body Fat %</label>
                            <input type="number" id="bodyFat" placeholder="15" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Muscle Mass (kg)</label>
                            <input type="number" id="muscleMass" placeholder="60" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Waist (cm)</label>
                            <input type="number" id="waist" placeholder="80" step="0.5">
                        </div>
                        <div class="input-group">
                            <label>Height (cm)</label>
                            <input type="number" id="height" placeholder="175" step="0.5">
                        </div>
                    </div>
                    <button class="btn-save" onclick="saveMeasurements()">Save Measurements</button>
                </div>

                <div class="card">
                    <h3>📊 All Measurements</h3>
                    <div id="progressHistory">
                        <div class="empty-state">
                            <h4>No measurements yet</h4>
                            <p>Take your first measurements above!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Challenges Section -->
            <div id="challenges" class="section">
              <div class="card">
                <h3>🔥 Challenges</h3>
            
                <!-- Collapsible Create Challenge -->
                <div class="challenge-create-header btn-secondary" onclick="toggleChallengeForm()">
                  <span class="chevron">▼</span> Create A Challenge
                </div>
            
                <div id="challengeFormContainer" style="display:none;">
                  <form id="challengeForm" onsubmit="createChallenge(event)">
                    <label for="challengeType">Challenge Type:</label>
                    <select id="challengeType" required>
                      <option value="pushups">Push-Ups</option>
                      <option value="running">Running</option>
                      <option value="cycling">Cycling</option>
                    </select>

                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate" required>
            
                    <div id="challengeOptions"></div>
            
                    <button type="submit" class="btn-save full-width">Save Challenge</button>
                  </form>
                </div>
              </div>
            
              <!-- List of Challenges with Tracking -->
              <div class="card">
                <h4>Active Challenges</h4>
                <div id="activeChallenges"></div>
              </div>

              <!-- Completed Challenges -->
              <div class="card">
                <h4>Completed Challenges</h4>
                <div id="completedChallenges"></div>
              </div>
            </div>

        </div>

        <!-- Feedback Modal -->
        <div id="feedbackModal" class="modal">
          <div class="modal-content">
            <h3>Workout Feedback</h3>
        
            <div class="input-group">
              <label for="rpeInput">Rate your effort (RPE)</label>
              <input type="number" id="rpeInput" min="1" max="10" placeholder="1–10">
            </div>
        
            <div class="input-group">
              <label for="notesInput">Notes</label>
              <textarea id="notesInput" rows="4" placeholder="How did it go?"></textarea>
            </div>
        
            <div class="modal-actions">
              <button class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button>
              <button class="btn btn-save" onclick="submitFeedback()">Save</button>
            </div>
          </div>
        </div>

        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
          <button class="nav-item active" onclick="showSection('dashboard', this)">
            <i class="fas fa-home"></i>
            <span>Home</span>
          </button>
          <button class="nav-item" onclick="showSection('workouts', this)">
            <i class="fas fa-dumbbell"></i>
            <span>Workouts</span>
          </button>
          <button class="nav-item" onclick="showSection('tracking', this)">
            <i class="fas fa-chart-line"></i>
            <span>Tracking</span>
          </button>
          <button class="nav-item" onclick="toggleMoreMenu()">
            <i class="fas fa-ellipsis-h"></i>
            <span>More</span>
          </button>
        </nav>

        
        <!-- More Menu in Bottom Nav -->
        <div id="moreMenu" class="more-menu">
          <button onclick="showSection('exercises', this)"><i class="fas fa-running"></i> Exercises</button>
          <button onclick="showSection('challenges', this)"><i class="fa-solid fa-list-check"></i> Challenges</button>
          <button onclick="showSection('plans', this)"><i class="fas fa-calendar-alt"></i> Plans</button>
          <button onclick="showSection('schedule', this)"><i class="fa-solid fa-calendar-day"></i> Schedule</button>
          <button onclick="showSection('goals', this)"><i class="fa-solid fa-bullseye"></i> Goals</button>
          <button onclick="showSection('achievements', this)"><i class="fas fa-trophy"></i> Achievements</button>
          <button onclick="showSection('measurements', this)"><i class="fa-solid fa-bars-progress"></i> Progress</button> 
          <button onclick="showSection('settings', this)"><i class="fas fa-cog"></i> Settings</button>
        </div>

    </div>
    <!-- End content -->

    <!-- the below modal is outside the main content div as it appears above it -->
    <!-- Exercise Selection Modal -->
    <div id="exerciseModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeExerciseSelector()">&times;</span>
            <h3>Select Exercises</h3>
            <div id="modalFilterTabs" class="filter-tabs" style="margin-bottom: 16px;"></div>
            <div id="modalExerciseGrid" class="exercise-grid"></div>
            <button class="btn" onclick="confirmExerciseSelection()">Add Selected Exercises</button>
        </div>
    </div>

    


<!-- *******************************
//         JAVASCRIPT        
// ******************************* -->
<script>
    // Register service worker file
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/claude-fitness-tracker/sw.js')
                .then(registration => {
                         console.log('Service Worker registered with scope:', registration.scope);
        
                    // This event fires when an update is found on the server
                        registration.onupdatefound = () => {
                            const installingWorker = registration.installing;
                            if (installingWorker) {
                                // The statechange event tracks the service worker's installation status
                                installingWorker.onstatechange = () => {
                                    if (installingWorker.state === 'installed') {
                                        if (navigator.serviceWorker.controller) {
                                            // New content is available! Display the banner to the user.
                                            const updateBanner = document.getElementById('update-banner');
                                            updateBanner.style.display = 'block';
        
                                            // Add a click listener to the reload link
                                            document.getElementById('reload-link').addEventListener('click', (event) => {
                                                event.preventDefault(); // Prevent the default link behavior
                                                window.location.reload(); // Force a full page reload
                                            });
                                        }
                                    }
                                };
                            }
                        };
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
        
        // Data storage global declarations
        let workouts = JSON.parse(window.localStorage?.getItem('fittrack-workouts') || '[]');
        if (!Array.isArray(workouts)) workouts = [];
        
        let plans = JSON.parse(window.localStorage?.getItem('fittrack-plans') || '[]');
        if (!Array.isArray(plans)) plans = [];
        
        let schedule = JSON.parse(window.localStorage?.getItem('fittrack-schedule') || '{}');
        if (typeof schedule !== 'object' || schedule === null || Array.isArray(schedule)) {
            schedule = {};
        }
        
        let tracking = JSON.parse(window.localStorage?.getItem('fittrack-tracking') || '[]');
        if (!Array.isArray(tracking)) tracking = [];
        
        let measurements = JSON.parse(window.localStorage?.getItem('fittrack-measurements') || '[]');
        if (!Array.isArray(measurements)) measurements = [];
        
        let achievements = JSON.parse(window.localStorage?.getItem('fittrack-achievements') || '[]');
        if (!Array.isArray(achievements)) achievements = [];
        
        let workoutCompletions = JSON.parse(window.localStorage?.getItem('fittrack-completions') || '[]');
        if (!Array.isArray(workoutCompletions)) workoutCompletions = [];
        
        let goals = JSON.parse(window.localStorage?.getItem('fittrack-goals') || '[]');
        if (!Array.isArray(goals)) goals = [];

        let challenges = JSON.parse(localStorage.getItem("challenges") || "[]");
        if (!Array.isArray(goals)) challenges = [];

        let selectedExercises = [];
        let currentFilter = 'all';

        // Allowing links to go to direct 'pages' using hash change
        window.addEventListener("hashchange", () => {
          const sec = location.hash.replace("#", "");
          if (sec) {
            const navBtn = document.querySelector(`.nav .nav-item[onclick*="${sec}"]`);
            showSection(sec, navBtn);
          }
        });

        // Achievement definitions
        const achievementDefinitions = [
            // Workout Achievements
            {
                id: 'first_workout',
                name: 'Getting Started',
                description: 'Complete your first workout',
                icon: '🎯',
                category: 'workout',
                check: () => workoutCompletions.length >= 1
            },
            {
                id: 'workout_5',
                name: 'Momentum Builder',
                description: 'Complete 5 workouts',
                icon: '💪',
                category: 'workout',
                check: () => workoutCompletions.length >= 5
            },
            {
                id: 'workout_10',
                name: 'Dedicated',
                description: 'Complete 10 workouts',
                icon: '🔥',
                category: 'workout',
                check: () => workoutCompletions.length >= 10
            },
            {
                id: 'workout_25',
                name: 'Fitness Enthusiast',
                description: 'Complete 25 workouts',
                icon: '⭐',
                category: 'workout',
                check: () => workoutCompletions.length >= 25
            },
            {
                id: 'workout_50',
                name: 'Iron Will',
                description: 'Complete 50 workouts',
                icon: '🏆',
                category: 'workout',
                check: () => workoutCompletions.length >= 50
            },
            
            // Progress Achievements
            {
                id: 'first_measurement',
                name: 'Baseline Set',
                description: 'Take your first body measurements',
                icon: '📏',
                category: 'progress',
                check: () => measurements.length >= 1
            },
            {
                id: 'weight_tracked',
                name: 'Scale Master',
                description: 'Track weight for 5 different days',
                icon: '⚖️',
                category: 'progress',
                check: () => measurements.length >= 5
            },
            {
                id: 'body_recomp',
                name: 'Body Recomposition',
                description: 'Track both weight and body fat percentage',
                icon: '📊',
                category: 'progress',
                check: () => measurements.some(m => m.weight > 0 && m.bodyFat > 0)
            },
            {
                id: 'progress_month',
                name: 'Monthly Tracker',
                description: 'Track progress for 30 days',
                icon: '📅',
                category: 'progress',
                check: () => {
                    if (measurements.length === 0) return false;
                    const firstDate = new Date(Math.min(...measurements.map(m => new Date(m.date))));
                    const daysDiff = (new Date() - firstDate) / (1000 * 60 * 60 * 24);
                    return daysDiff >= 30;
                }
            },
            
            // Consistency Achievements
            {
                id: 'daily_logger',
                name: 'Daily Logger',
                description: 'Track nutrition for 7 consecutive days',
                icon: '🍎',
                category: 'consistency',
                check: () => {
                    if (tracking.length < 7) return false;
                    const sorted = tracking.sort((a, b) => new Date(b.date) - new Date(a.date));
                    for (let i = 0; i < 7; i++) {
                        const expectedDate = new Date();
                        expectedDate.setDate(expectedDate.getDate() - i);
                        const dateStr = expectedDate.toISOString().split('T')[0];
                        if (!sorted.find(n => n.date === dateStr)) return false;
                    }
                    return true;
                }
            },
            {
                id: 'step_crusher',
                name: 'Step Crusher',
                description: 'Hit 10,000+ steps in a day',
                icon: '👟',
                category: 'consistency',
                check: () => tracking.some(n => n.steps >= 10000)
            },
            {
                id: 'hydration_hero',
                name: 'Hydration Hero',
                description: 'Drink 3+ liters of water in a day',
                icon: '💧',
                category: 'consistency',
                check: () => tracking.some(n => n.water >= 3.0)
            },
            {
                id: 'protein_power',
                name: 'Protein Power',
                description: 'Hit 150g+ protein in a day',
                icon: '🥩',
                category: 'consistency',
                check: () => tracking.some(n => n.protein >= 150)
            },
            {
                id: 'workout_streak_7',
                name: 'Weekly Warrior',
                description: 'Complete workouts 7 days in a row',
                icon: '🔥',
                category: 'consistency',
                check: () => {
                    if (workoutCompletions.length < 7) return false;
                    const sorted = workoutCompletions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    for (let i = 0; i < 7; i++) {
                        const expectedDate = new Date();
                        expectedDate.setDate(expectedDate.getDate() - i);
                        const dateStr = expectedDate.toISOString().split('T')[0];
                        if (!sorted.find(w => w.date === dateStr)) return false;
                    }
                    return true;
                }
            }
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todaysDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('trackingDate').value = today;
            document.getElementById('measurementDate').value = today;
            document.getElementById('scheduleStartDate').value = today;
            // Run after exercises.js is loaded
            document.getElementById("exerciseCount").textContent = `Choose from ${exercises.length} exercises below...`;

            
            //exercises = exerciseDatabase; no longer needed; exercises now coming from exercises.js file
            loadData();
            loadGoals();
            updateAllDisplays();
            showGreeting();
            displayCompletedWorkouts();
            updateActiveWorkoutCount();
        });

        // Header items for search and the calendar - these are placeholders for future features
        document.querySelector(".fa-search").addEventListener("click", () => {
          alert("Search feature coming soon!");
        });
        
        document.querySelector(".fa-calendar-alt").addEventListener("click", () => {
          alert("Calendar view coming soon!");
        });

        // Navigation
        function showSection(sectionName, clickedButton) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Add active to clicked nav item
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            // Update displays for specific sections that need refresh
            if (sectionName === 'exercises') {
                displayExerciseLibrary();
            } else if (sectionName === 'workouts') {
                updateWorkoutsList();
            } else if (sectionName === 'plans') {
                updatePlansList();
            } else if (sectionName === 'schedule') {
                updateCurrentSchedule();
            } else if (sectionName === 'goals') {
                updateGoalsDisplay();
                updateChartsDisplay();
            } else if (sectionName === 'achievements') {
                updateAchievementsDisplay();
            } else if (sectionName === 'tracking') { 
                updateDailyTrackingHistory(); 
            } else if (sectionName === 'measurements') {
                updateProgressHistory();
            } else if (sectionName === 'challenges') {
                displayChallenges();
            }
            // Close "More" menu if open
            const moreMenu = document.getElementById("moreMenu");
            if (moreMenu) moreMenu.classList.remove("show");

        }

        // === Bottom Navigation Logic ===
        // More Menu toggle logic
        document.getElementById("moreButton").addEventListener("click", () => {
          const menu = document.getElementById("moreMenu");
          menu.classList.toggle("show");
        });
        
        // Hide More menu when clicking outside
        document.addEventListener("click", (e) => {
          const menu = document.getElementById("moreMenu");
          const moreBtn = document.getElementById("moreButton");
          if (!menu.contains(e.target) && e.target !== moreBtn && !moreBtn.contains(e.target)) {
            menu.classList.remove("show");
          }
        });

        // Allowing the 'more' menu to slide up and fade in
        function toggleMoreMenu() {
          const menu = document.getElementById("moreMenu");
          menu.classList.toggle("show");
        }
        
        // Close More menu when clicking outside or selecting an item
        document.addEventListener("click", function (event) {
          const menu = document.getElementById("moreMenu");
          const moreButton = document.querySelector(".nav-item[data-tab='more']") || document.querySelector(".nav-item:has(.fa-ellipsis-h)");
        
          if (!menu) return;
        
          // If menu is open
          if (menu.classList.contains("show")) {
            const clickedInsideMenu = menu.contains(event.target);
            const clickedMoreButton = moreButton && moreButton.contains(event.target);
        
            // Close if clicked outside both the menu and the button
            if (!clickedInsideMenu && !clickedMoreButton) {
              menu.classList.remove("show");
            }
          }
        });
        
        // Also close when clicking one of the menu items
        document.querySelectorAll("#moreMenu button").forEach(btn => {
          btn.addEventListener("click", () => {
            document.getElementById("moreMenu").classList.remove("show");
          });
        });


        // **************************
        // Exercise Library Functions
        function displayExerciseLibrary() {
            const container = document.getElementById('exerciseLibrary');
            container.innerHTML = '';
            
            // Create filters
            const allMuscles = [...new Set(exercises.map(ex => ex.primaryMuscle))];
            const filterContainer = document.createElement('div');
            filterContainer.className = 'filter-tabs';
            filterContainer.innerHTML = `
                <span class="filter-tab active" data-filter="all">All</span>
                ${allMuscles.map(muscle => `<span class="filter-tab" data-filter="${muscle}">${muscle}</span>`).join('')}
            `;
            container.appendChild(filterContainer);
            
            // Add event listeners for filters
            filterContainer.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    filterContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    
                    const items = container.querySelectorAll('.exercise-item');
                    items.forEach(item => {
                        if (filter === 'all' || item.dataset.muscle === filter) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            });
        
            // Build exercise cards
            exercises.forEach(exercise => {
                const item = document.createElement('div');
                item.className = 'exercise-item';
                item.dataset.muscle = exercise.primaryMuscle;
                item.dataset.id = exercise.id;
                item.innerHTML = `
                    <div class="exercise-details">
                        <div class="exercise-header">
                            <div class="exercise-name">${exercise.name}</div>
                            <span class="equipment-badge ${exercise.equipment.toLowerCase().replace(/\s+/g, '-')}">
                                ${exercise.equipment}
                            </span>
                        </div>
                        <div class="exercise-muscle">
                            ${exercise.primaryMuscle}
                            ${exercise.secondaryMuscles && exercise.secondaryMuscles.length > 0 
                                ? ` + ${exercise.secondaryMuscles.join(', ')}` 
                                : ''}
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }


        function filterExercises(muscle) {
            currentFilter = muscle;
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            displayExerciseLibrary();
        }

        // Exercise Selection Modal
        function openExerciseSelector() {
            document.getElementById('exerciseModal').classList.add('active');
            displayModalExercises();
        }

        function closeExerciseSelector() {
            document.getElementById('exerciseModal').classList.remove('active');
        }

        function displayModalExercises() {
            const container = document.getElementById('modalExerciseGrid');
            const modalFilterContainer = document.getElementById('modalFilterTabs');
        
            // Create filter tabs dynamically
            const allMuscles = [...new Set(exercises.map(ex => ex.primaryMuscle))];
            modalFilterContainer.innerHTML = `
                <span class="filter-tab ${currentFilter === 'all' ? 'active' : ''}" data-filter="all">All</span>
                ${allMuscles.map(muscle => `
                    <span class="filter-tab ${currentFilter === muscle ? 'active' : ''}" data-filter="${muscle}">${muscle}</span>
                `).join('')}
            `;
        
            // Add click listeners to tabs
            modalFilterContainer.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    currentFilter = filter;
                    displayModalExercises(); // refresh the modal list with the new filter
                });
            });
        
            // Filter exercises
            const filteredExercises = currentFilter === 'all' ? exercises : exercises.filter(ex => ex.primaryMuscle === currentFilter);
        
            // Build exercise items
            container.innerHTML = filteredExercises.map(exercise => `
                <div class="exercise-item ${selectedExercises.find(e => e.id === exercise.id) ? 'selected' : ''}" 
                     onclick="toggleExerciseSelection('${exercise.id}')">
                    <div class="exercise-details">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="exercise-muscle">
                            ${exercise.primaryMuscle}
                            ${exercise.secondaryMuscles && exercise.secondaryMuscles.length > 0 ? ` + ${exercise.secondaryMuscles.join(', ')}` : ''}
                            • ${exercise.equipment}
                        </div>
                    </div>
                </div>
            `).join('');
        }


        function filterModalExercises(muscle) {
            currentFilter = muscle;
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            displayModalExercises();
        }

        function toggleExerciseSelection(exerciseId) {
            const exercise = exercises.find(e => e.id === exerciseId);
            const existingIndex = selectedExercises.findIndex(e => e.id === exerciseId);
            
            if (existingIndex >= 0) {
                selectedExercises.splice(existingIndex, 1);
            } else {
                selectedExercises.push({
                    ...exercise,
                    sets: 3,
                    reps: 10,
                    weight: 0
                });
            }
            
            displayModalExercises();
            updateSelectedExercisesDisplay();
        }

        function confirmExerciseSelection() {
            closeExerciseSelector();
            updateSelectedExercisesDisplay();
        }

        function updateSelectedExercisesDisplay() {
            const container = document.getElementById('selectedExercises');
            
            if (selectedExercises.length === 0) {
                container.innerHTML = '<p style="opacity: 0.6; font-size: 14px;">No exercises selected</p>';
                return;
            }
            
            container.innerHTML = selectedExercises.map((exercise, index) => `
                <div class="exercise-item">
                    <div class="exercise-header">
                        <div class="exercise-name">${exercise.name}</div>
                            <button class="btn btn-danger btn-sm delete-btn" onclick="removeSelectedExercise(${index})">
                              <i class="bi bi-trash"></i>
                            </button>
                    </div>
                    <div class="set-inputs">
                        <input type="number" placeholder="Sets" value="${exercise.sets}" 
                               onchange="updateExerciseParam(${index}, 'sets', this.value)">
                        <input type="number" placeholder="Reps" value="${exercise.reps}"
                               onchange="updateExerciseParam(${index}, 'reps', this.value)">
                        <input type="number" placeholder="Weight" value="${exercise.weight}"
                               onchange="updateExerciseParam(${index}, 'weight', this.value)">
                    </div>
                </div>
            `).join('');

        }

        function updateExerciseParam(index, param, value) {
            selectedExercises[index][param] = parseFloat(value) || 0;
        }

        function removeSelectedExercise(index) {
            selectedExercises.splice(index, 1);
            updateSelectedExercisesDisplay();
        }

        // **********************
        // Workout Management
        // **********************
        
        // Logic to switch tabs between planned and completed workouts
        function switchWorkoutTab(e) {
          const tab = e.currentTarget;
          const tabName = tab.dataset.tab;
        
          // remove active from all buttons
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          tab.classList.add('active');
        
          // hide all tab contents
          document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
          document.getElementById('workoutsTab-' + tabName).style.display = 'block';
        }

        function updateActiveWorkoutCount() {
          const workouts = JSON.parse(localStorage.getItem("workouts")) || [];
          document.getElementById("activeWorkoutCount").textContent = workouts.length;
        }

        function toggleWorkoutDetails(header) {
          const card = header.parentElement;
          card.classList.toggle("active");
        
          const details = card.querySelector(".workout-details");
          details.style.display = details.style.display === "block" ? "none" : "block";
        }


        function saveWorkout() {
            const name = document.getElementById('workoutName').value;
            
            if (!name || selectedExercises.length === 0) {
                alert('Please enter a workout name and select exercises');
                return;
            }
            
            const workout = {
                id: Date.now(),
                name: name,
                exercises: [...selectedExercises],
                created: new Date().toISOString()
            };
            
            workouts.push(workout);
            saveData();
            
            // Clear form
            document.getElementById('workoutName').value = '';
            selectedExercises = [];
            updateSelectedExercisesDisplay();
            updateWorkoutsList();
            updateDashboard();
            
            alert('Workout saved successfully!');
            updateActiveWorkoutCount();
        }

        function deleteWorkout(id) {
            if (confirm('Delete this workout?')) {
                workouts = workouts.filter(w => w.id !== id);
                saveData();
                updateWorkoutsList();
                updateDashboard();
            }
            updateActiveWorkoutCount();
        }

        function updateWorkoutsList() {
            const container = document.getElementById('workoutsList');
            
            if (workouts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>No workouts created</h4>
                        <p>Create your first workout above!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = workouts.map(workout => `
                <div class="workout-item">
                    <div class="workout-header">
                        <div class="workout-name">${workout.name}</div>
                        <div class="workout-actions">
                            <button class="btn-start" onclick="startWorkout(${workout.id})"><i class="bi bi-play-fill"></i></button>
                            <button class="btn-delete" onclick="deleteWorkout(${workout.id})"><i class="bi bi-trash"></i></button>
                        </div>                    
                    </div>
                    <div class="workout-exercises">
                        <ul>
                            ${workout.exercises.map(ex => `
                                <li>${ex.name}: ${ex.sets} × ${ex.reps}${ex.weight > 0 ? ' @ ' + ex.weight + 'kg' : ''}</li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `).join('');
            
            updateActiveWorkoutCount();
        }

        let activeWorkout = null;
        let workoutTimerInterval = null;
        let pausedElapsed = 0;

        // Reset & start timer ⏱
        function startTimer() {
            clearInterval(workoutTimerInterval);
            workoutTimerInterval = setInterval(updateTimer, 1000);
        }

        // Stop the timer interval
        function stopTimer() {
          clearInterval(workoutTimerInterval);
          workoutTimerInterval = null;
        }
    
        // Workout timer
        function updateTimer() {
          if (!activeWorkout) return;
        
          // elapsed seconds = already paused time + (now - startTime) if running
          const now = new Date();
          const runningSeconds = activeWorkout.startTime ? Math.floor((now - new Date(activeWorkout.startTime)) / 1000) : 0;
          const elapsed = pausedElapsed + (activeWorkout.paused ? 0 : runningSeconds);
        
          const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0');
          const seconds = String(elapsed % 60).padStart(2, '0');
        
          const timerEl = document.getElementById('workoutTimer');
          if (timerEl) timerEl.innerText = `${minutes}:${seconds}`;
        
          // Keep pill class and button label in sync (safe even if element missing)
          const wrapper = document.getElementById('workoutTimerWrapper');
          if (wrapper) {
            wrapper.classList.toggle('paused', !!activeWorkout.paused);
            wrapper.classList.toggle('running', !activeWorkout.paused);
          }
          const btn = document.getElementById('pauseResumeBtn');
          if (btn) btn.innerText = activeWorkout.paused ? '▶ Resume' : '⏸ Pause';
        }

        // Start workout
        function startWorkout(workoutId) {
            const workout = workouts.find(w => w.id === workoutId);
            if (!workout) return;
        
            activeWorkout = {
                ...workout,
                startTime: new Date(),
                endTime: null,
                paused: false
            };
            pausedElapsed = 0;
        
            renderActiveWorkout();
            startTimer();  
        }

        function togglePauseWorkout() {
          if (!activeWorkout) return;
        
          if (activeWorkout.paused) {
            // --- RESUME ---
            activeWorkout.paused = false;
        
            // set new base start time (elapsed preserved in pausedElapsed)
            activeWorkout.startTime = new Date();
        
            // re-render UI so button/pill are correct, then restart timer
            renderActiveWorkout();
            startTimer();
          } else {
            // --- PAUSE ---
            activeWorkout.paused = true;
        
            // capture elapsed seconds so far and stop interval
            const now = new Date();
            if (activeWorkout.startTime) {
              pausedElapsed += Math.floor((now - new Date(activeWorkout.startTime)) / 1000);
            }
        
            stopTimer();
        
            // re-render UI so button/pill are correct and show paused time
            renderActiveWorkout();
            updateTimer(); // ensure display shows final paused value
          }
        }

        // Finish workout
        function finishWorkout() {
          if (!activeWorkout) return;
        
          // stop timer
          stopTimer();
        
          const end = new Date(); // real Date object
          activeWorkout.endTime = end.toISOString();
        
          // Ensure startTime is parsed correctly
          const start = new Date(activeWorkout.startTime);
        
          // Duration in minutes
          activeWorkout.duration = Math.round((end - start) / 1000 / 60);
        
          // Calculate per-exercise volume
          activeWorkout.exercises.forEach(ex => {
            const setsCompleted = ex.completedSets ? ex.completedSets.length : 0;
            const reps = parseInt(ex.reps) || 0;
            const weight = parseFloat(ex.weight) || 0;
        
            ex.setsCompleted = setsCompleted;
            ex.volume = setsCompleted * reps * weight;
          });
        
          // Workout total volume
          activeWorkout.totalVolume = activeWorkout.exercises.reduce(
            (sum, ex) => sum + (ex.volume || 0),
            0
          );
        
          // 👉 Instead of saving here, show feedback modal
          document.getElementById("feedbackModal").style.display = "flex";
        }
        
        function submitFeedback() {
          const rpe = document.getElementById("rpeInput").value;
          const notes = document.getElementById("notesInput").value;
        
          // Attach feedback
          activeWorkout.rpe = rpe;
          activeWorkout.notes = notes;
        
          // Save workout to completed list
          let completed = JSON.parse(localStorage.getItem("completedWorkouts") || "[]");
          completed.push(activeWorkout);
          localStorage.setItem("completedWorkouts", JSON.stringify(completed));
        
          // 📊 Save volume log
          let volumeLog = JSON.parse(localStorage.getItem("workoutVolumeLog") || "[]");
          volumeLog.push({
            date: activeWorkout.endTime,
            volume: activeWorkout.totalVolume
          });
          localStorage.setItem("workoutVolumeLog", JSON.stringify(volumeLog));
        
          // ✅ Clear completedSets so future runs start fresh
          workouts = workouts.map(w => {
            if (w.id === activeWorkout.id) {
              return {
                ...w,
                exercises: w.exercises.map(ex => ({ ...ex, completedSets: [] }))
              };
            }
            return w;
          });
        
          // Reset state
          activeWorkout = null;
          pausedElapsed = 0;
          document.getElementById("activeWorkoutContainer").innerHTML = "";
        
          // Hide modal
          closeFeedbackModal();
        
          // Refresh UI
          displayCompletedWorkouts();
          displayVolumeStats();
        
          // ✅ Switch to Completed tab safely
          const completedTab = document.querySelector('[data-tab="completed"]');
          if (completedTab) {
            switchWorkoutTab({ target: completedTab });
          }
        }

        function closeFeedbackModal() {
          document.getElementById("feedbackModal").style.display = "none";
        }

        
        // Render active workouts
        function renderActiveWorkout() {
          const container = document.getElementById("activeWorkoutContainer");
        
          container.innerHTML = `
            <div class="active-workout-card" id="activeWorkoutCard">
              <h3>Active Workout: ${activeWorkout.name}</h3>
              <p>Started at: ${activeWorkout.startTime.toLocaleTimeString()}</p>
        
              <!-- Timer -->
              <div class="workout-timer-container">
                <div class="workout-timer ${activeWorkout.paused ? 'paused' : 'running'}">
                   ⏱ <span id="workoutTimer">00:00</span>
                </div>
        
                <div class="timer-controls">
                  <button id="pauseResumeBtn" class="btn-pause" onclick="togglePauseWorkout()">
                    ${activeWorkout.paused ? "▶ Resume" : "⏸ Pause"}
                  </button>
                </div>
              </div>
        
              <!-- Exercises -->
              <div class="exercise-list">
                  ${activeWorkout.exercises.map((ex, i) => `
                    <div class="exercise-block">
                      <h5>${ex.name}</h5>
                      ${Array.from({ length: ex.sets }).map((_, setIndex) => {
                        const isChecked =
                          ex.completedSets && ex.completedSets.includes(setIndex)
                            ? "checked"
                            : "";
                
                        // 👇 Decide how to display the set
                        const setText = ex.weight && ex.weight !== "-"
                          ? `Set ${setIndex + 1}: ${ex.reps} reps @ ${ex.weight} kg`
                          : `Set ${setIndex + 1}: ${ex.reps} reps using bodyweight`;
                          
                      return `
                        <div class="set-row">
                          <label>
                            <input type="checkbox" ${isChecked} onchange="toggleSetComplete(${i}, ${setIndex})">
                            Set ${setIndex + 1}: ${ex.reps} reps @ ${ex.weight || '-'} kg
                          </label>
                        </div>
                      `;
                    }).join("")}
                  </div>
                `).join("")}
              </div>
        
              <!-- Finish button -->
              <div class="finish-controls">
                <button class="btn-finish" onclick="finishWorkout()">Finish ⏹</button>
              </div>
            </div>
          `;
        
          if (workoutTimerInterval) clearInterval(workoutTimerInterval);
          workoutTimerInterval = setInterval(updateTimer, 1000);
        
          // ✅ Scroll into view once the card exists
          const card = document.getElementById("activeWorkoutCard");
          if (card) {
            card.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }


        // Display Completed Workouts
        function displayCompletedWorkouts() {
          const container = document.getElementById("completedWorkoutsList");
          container.innerHTML = "";
        
          const completed = JSON.parse(localStorage.getItem("completedWorkouts")) || [];
        
          if (!completed.length) {
            container.innerHTML = "<p>No completed workouts yet.</p>";
            return;
          }
        
          // ✅ Sort newest → oldest
          completed.sort((a, b) => new Date(b.endTime || b.startTime) - new Date(a.endTime || a.startTime));
        
          const groups = {};
        
          completed.forEach(workout => {
            const rawDate = workout.endTime || workout.startTime;
            const d = new Date(rawDate);
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);
        
            let label;
            if (d.toDateString() === today.toDateString()) {
              label = "Today";
            } else if (d.toDateString() === yesterday.toDateString()) {
              label = "Yesterday";
            } else {
              label = d.toLocaleString("default", { month: "long", year: "numeric" });
            }
        
            if (!groups[label]) groups[label] = [];
            groups[label].push(workout);
          });
        
          // ✅ Render in correct order
          if (groups["Today"]) {
            renderWorkoutGroup(container, "Today", groups["Today"]);
            delete groups["Today"];
          }
          if (groups["Yesterday"]) {
            renderWorkoutGroup(container, "Yesterday", groups["Yesterday"]);
            delete groups["Yesterday"];
          }
        
          // For months → sort newest first
          const monthKeys = Object.keys(groups).sort((a, b) => {
            const da = new Date(a);
            const db = new Date(b);
            return db - da;
          });
        
          monthKeys.forEach(label => {
            renderWorkoutGroup(container, label, groups[label]);
          });
        }

        
        // 🔧 Helper to render one group (collapsible)
        function renderWorkoutGroup(container, label, workouts) {
          const section = document.createElement("div");
          section.classList.add("workout-group");
        
          const header = document.createElement("div");
          header.classList.add("workout-group-header");
          header.innerHTML = `
            <span class="group-chevron">▶</span>
            <span>${label}</span>
          `;
        
          const content = document.createElement("div");
          content.classList.add("workout-group-content");
        
          // ✅ Expand Today + Yesterday by default
          const shouldExpand = label === "Today" || label === "Yesterday";
          content.style.display = shouldExpand ? "block" : "none";
          if (shouldExpand) {
            header.querySelector(".group-chevron").classList.add("open");
          }
        
          workouts.forEach((workout, index) => {
            const card = document.createElement("div");
            card.classList.add("workout-card");
        
            const rawDate = workout.endTime || workout.startTime;
            const date = rawDate
              ? new Date(rawDate).toLocaleDateString(undefined, {
                  year: "numeric",
                  month: "short",
                  day: "numeric"
                })
              : "Unknown";
        
            card.innerHTML = `
              <div class="workout-header">
                <div class="workout-title">
                  <span class="chevron">▶</span>
                  <span>${workout.name}</span>
                </div>
                <div class="workout-meta-actions">
                  <span class="workout-date">${date}</span>
                  <button class="delete-btn" title="Delete Workout">🗑</button>
                </div>
              </div>
              <div class="workout-details" id="workoutDetails-${label}-${index}" style="display: none;">
                  <div class="workout-meta">
                    <span><strong>Time:</strong> ${workout.duration ? workout.duration + " mins" : "N/A"}</span>
                    <span><strong>Weight:</strong> ${workout.totalVolume || 0} kg</span>
                  </div>
                
                  <ul class="exercise-list">
                    ${workout.exercises.map(ex => {
                      const detail = ex.weight && ex.weight !== "-"
                        ? `${ex.setsCompleted} sets, ${ex.volume} kg`
                        : `${ex.setsCompleted} sets using bodyweight`;
                      return `<li>${ex.name}: ${detail}</li>`;
                    }).join("")}
                  </ul>
                
                  ${workout.rpe ? `<div class="workout-feedback"><strong>RPE:</strong> ${workout.rpe}</div>` : ""}
                  ${workout.notes ? `<div class="workout-feedback"><strong>Notes:</strong> ${workout.notes}</div>` : ""}
                </div>

            `;
        
            // Toggle details
            const headerEl = card.querySelector(".workout-title");
            const chevron = card.querySelector(".chevron");
            const details = card.querySelector(".workout-details");
        
            headerEl.addEventListener("click", () => {
              const isOpen = details.style.display === "block";
              details.style.display = isOpen ? "none" : "block";
              chevron.classList.toggle("open", !isOpen);
            });
        
            // Delete button handler
            const deleteBtn = card.querySelector(".delete-btn");
            deleteBtn.addEventListener("click", (e) => {
              e.stopPropagation(); // don’t toggle the details
              if (confirm("Delete this workout?")) {
                let completed = JSON.parse(localStorage.getItem("completedWorkouts")) || [];
                completed = completed.filter(w => !(w.startTime === workout.startTime && w.name === workout.name));
                localStorage.setItem("completedWorkouts", JSON.stringify(completed));
                displayCompletedWorkouts(); // refresh
              }
            });
        
            content.appendChild(card);
          });
        
          // Collapsible group toggle
          header.addEventListener("click", () => {
            const isOpen = content.style.display === "block";
            content.style.display = isOpen ? "none" : "block";
            header.querySelector(".group-chevron").classList.toggle("open", !isOpen);
          });
        
          section.appendChild(header);
          section.appendChild(content);
          container.appendChild(section);
        }

        document.addEventListener("DOMContentLoaded", () => {
          displayCompletedWorkouts();
        });
        
        function toggleSetComplete(exIndex, setIndex) {
              const exercise = activeWorkout.exercises[exIndex];
            
              if (!exercise.completedSets) exercise.completedSets = [];
            
              if (exercise.completedSets.includes(setIndex)) {
                // uncheck
                exercise.completedSets = exercise.completedSets.filter(i => i !== setIndex);
              } else {
                // check
                exercise.completedSets.push(setIndex);
              }
        }

        // Helper function to abbreviate numbers in the displayVolumeSets if they get too big
        function formatVolume(n) {
            if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
            if (n >= 1_000) return (n / 1_000).toFixed(1) + 'k';
            return n; // small numbers stay as-is
        }

        // Display volume stats
        function displayVolumeStats() {
              const log = JSON.parse(localStorage.getItem("workoutVolumeLog") || "[]");
              const now = new Date();
            
              const totals = { week: 0, month: 0, year: 0, all: 0 };
            
              log.forEach(entry => {
                const d = new Date(entry.date);
                const v = Number(entry.volume) || 0;
            
                totals.all += v;
            
                // Monday start
                const weekStart = new Date(now);
                const day = now.getDay() || 7; // Sun=0 -> 7
                weekStart.setDate(now.getDate() - day + 1);
                weekStart.setHours(0, 0, 0, 0);
                if (d >= weekStart) totals.week += v;
            
                if (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
                  totals.month += v;
                }
                if (d.getFullYear() === now.getFullYear()) {
                  totals.year += v;
                }
              });
            
              const container = document.getElementById("volumeStats");
              if (!container) return;
            
              const R = 60;
              const C = 2 * Math.PI * R;
                          
              container.innerHTML = `
                  <div class="volume-grid">
                    <div class="volume-item">
                      <div class="donut">
                        <svg width="140" height="140">
                          <circle class="bg" r="${R}" cx="70" cy="70"></circle>
                          <circle class="progress" r="${R}" cx="70" cy="70"
                                  stroke="#a3dc9a" style="stroke-dasharray:${C}; stroke-dashoffset:0;"></circle>
                        </svg>
                        <div class="donut-text">${formatVolume(totals.week)} kg</div>
                      </div>
                      <div class="label">This Week</div>
                    </div>
                
                    <div class="volume-item">
                      <div class="donut">
                        <svg width="140" height="140">
                          <circle class="bg" r="${R}" cx="70" cy="70"></circle>
                          <circle class="progress" r="${R}" cx="70" cy="70"
                                  stroke="#dee791" style="stroke-dasharray:${C}; stroke-dashoffset:0;"></circle>
                        </svg>
                        <div class="donut-text">${formatVolume(totals.month)} kg</div>
                      </div>
                      <div class="label">This Month</div>
                    </div>
                
                    <div class="volume-item">
                      <div class="donut">
                        <svg width="140" height="140">
                          <circle class="bg" r="${R}" cx="70" cy="70"></circle>
                          <circle class="progress" r="${R}" cx="70" cy="70"
                                  stroke="#d29f80" style="stroke-dasharray:${C}; stroke-dashoffset:0;"></circle>
                        </svg>
                        <div class="donut-text">${formatVolume(totals.year)} kg</div>
                      </div>
                      <div class="label">This Year</div>
                    </div>
                
                    <div class="volume-item">
                      <div class="donut">
                        <svg width="140" height="140">
                          <circle class="bg" r="${R}" cx="70" cy="70"></circle>
                          <circle class="progress" r="${R}" cx="70" cy="70"
                                  stroke="#a2aadb" style="stroke-dasharray:${C}; stroke-dashoffset:0;"></circle>
                        </svg>
                        <div class="donut-text">${formatVolume(totals.all)} kg</div>
                      </div>
                      <div class="label">All Time</div>
                    </div>
                  </div>
                `;
        }

        if (document.getElementById("volumeStats")) {
            displayVolumeStats();
        }

        
        // ****************************
        // Plan Management
        function savePlan() {
            const name = document.getElementById('planName').value;
            const description = document.getElementById('planDescription').value;
            const duration = parseInt(document.getElementById('planDuration').value);
            
            if (!name || !duration) {
                alert('Please enter plan name and duration');
                return;
            }
            
            const plan = {
                id: Date.now(),
                name: name,
                description: description,
                duration: duration,
                workouts: {},
                created: new Date().toISOString()
            };
            
            plans.push(plan);
            saveData();
            
            // Clear form
            document.getElementById('planName').value = '';
            document.getElementById('planDescription').value = '';
            document.getElementById('planDuration').value = '';
            
            updatePlansList();
            updatePlanSelector();
            updateDashboard();
            
            alert('Plan created successfully!');
        }

        function deletePlan(id) {
            if (confirm('Delete this plan?')) {
                plans = plans.filter(p => p.id !== id);
                saveData();
                updatePlansList();
                updatePlanSelector();
                updateDashboard();
            }
        }

        function updatePlansList() {
            const container = document.getElementById('plansList');
            
            if (plans.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>No plans created</h4>
                        <p>Create your first training plan above!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = plans.map(plan => `
                <div class="plan-item">
                    <div class="workout-header">
                        <div>
                            <div class="workout-name">${plan.name}</div>
                            <div class="workout-exercises">${plan.description}</div>
                            <div class="workout-exercises">${plan.duration} weeks</div>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deletePlan(${plan.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function updatePlanSelector() {
            const selector = document.getElementById('planToSchedule');
            selector.innerHTML = '<option value="">Select a plan...</option>' + 
                plans.map(plan => `<option value="${plan.id}">${plan.name}</option>`).join('');
        }

        // Schedule Management
        function generateWeeklySchedule() {
            const planId = document.getElementById('planToSchedule').value;
            if (!planId) return;
            
            const container = document.getElementById('weeklySchedule');
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            container.innerHTML = `
                <label>Assign Workouts to Days</label>
                <div class="schedule-grid">
                    ${days.map(day => `
                        <div class="day-card" onclick="selectDayForWorkout('${day}')">
                            <div class="day-name">${day}</div>
                            <select id="workout-${day}" style="width: 100%; font-size: 10px; padding: 4px;">
                                <option value="">Rest</option>
                                ${workouts.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                            </select>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function saveSchedule() {
            const planId = document.getElementById('planToSchedule').value;
            const startDate = document.getElementById('scheduleStartDate').value;
            
            if (!planId || !startDate) {
                alert('Please select a plan and start date');
                return;
            }
            
            const plan = plans.find(p => p.id === parseInt(planId));
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const weekSchedule = {};
            
            days.forEach(day => {
                const workoutId = document.getElementById(`workout-${day}`)?.value;
                if (workoutId) {
                    weekSchedule[day] = parseInt(workoutId);
                }
            });
            
            schedule = {
                planId: parseInt(planId),
                planName: plan.name,
                startDate: startDate,
                duration: plan.duration,
                weekSchedule: weekSchedule
            };
            
            saveData();
            updateCurrentSchedule();
            updateTodaysWorkout();
            
            alert('Schedule saved successfully!');
        }

        function updateCurrentSchedule() {
            const container = document.getElementById('currentSchedule');
            
            if (!schedule.planName) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>No active schedule</h4>
                        <p>Create and schedule a plan above!</p>
                    </div>
                `;
                return;
            }
            
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            container.innerHTML = `
                <div class="workout-item">
                    <div class="workout-name">${schedule.planName}</div>
                    <div class="workout-exercises">Started: ${new Date(schedule.startDate).toLocaleDateString()}</div>
                    <div class="workout-exercises">${schedule.duration} weeks</div>
                </div>
                <div class="schedule-grid">
                    ${days.map(day => {
                        const workoutId = schedule.weekSchedule[day];
                        const workout = workoutId ? workouts.find(w => w.id === workoutId) : null;
                        return `
                            <div class="day-card">
                                <div class="day-name">${day}</div>
                                <div class="day-workout">${workout ? workout.name : 'Rest'}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function updateTodaysWorkout() {
            const container = document.getElementById('todaysWorkout');
            
            if (!schedule.planName) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>No workout scheduled</h4>
                        <p>Create a plan and schedule to see today's workout here</p>
                    </div>
                `;
                return;
            }
            
            const today = new Date();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const todayName = dayNames[today.getDay()];
            const todayShort = todayName === 'Sun' ? 'Sun' : todayName;
            
            const workoutId = schedule.weekSchedule[todayShort];
            const workout = workoutId ? workouts.find(w => w.id === workoutId) : null;
            
            if (!workout) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>Rest Day</h4>
                        <p>No workout scheduled for today</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="workout-item">
                    <div class="workout-name">${workout.name}</div>
                    <div class="workout-exercises">
                        ${workout.exercises.map(ex => 
                            `${ex.name}: ${ex.sets}x${ex.reps}${ex.weight > 0 ? ' @' + ex.weight + 'kg' : ''}`
                        ).join('<br>')}
                    </div>
                    <button class="btn btn-small" onclick="logWorkoutCompletion()">Mark as Completed</button>
                </div>
            `;
        }

        function logWorkoutCompletion() {
            const today = new Date().toISOString().split('T')[0];
            
            // Don't log duplicate completions for the same day
            if (workoutCompletions.find(w => w.date === today)) {
                alert('Workout already marked as completed for today!');
                return;
            }
            
            const todayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][new Date().getDay()];
            const todayShort = todayName === 'Sun' ? 'Sun' : todayName;
            const workoutId = schedule.weekSchedule?.[todayShort];
            const workout = workoutId ? workouts.find(w => w.id === workoutId) : null;
            
            workoutCompletions.push({
                id: Date.now(),
                date: today,
                workoutId: workoutId,
                workoutName: workout?.name || 'Workout'
            });
            
            saveData();
            checkAchievements();
            updateDashboard();
            showWorkoutReminder(); // Refresh reminder
            
            alert('🎉 Workout completed! Great job!');
        }

        // Achievement System
        function checkAchievements() {
            let newAchievements = [];
            
            achievementDefinitions.forEach(def => {
                // Check if already unlocked
                if (achievements.find(a => a.id === def.id)) return;
                
                // Check if conditions are met
                if (def.check()) {
                    const achievement = {
                        ...def,
                        unlockedDate: new Date().toISOString(),
                        isNew: true
                    };
                    achievements.push(achievement);
                    newAchievements.push(achievement);
                }
            });
            
            if (newAchievements.length > 0) {
                saveData();
                showNewAchievements(newAchievements);
                updateAchievementsDisplay();
            }
        }

        function showNewAchievements(newAchievements) {
            const card = document.getElementById('recentAchievementCard');
            const content = document.getElementById('recentAchievement');
            
            if (newAchievements.length === 1) {
                const achievement = newAchievements[0];
                content.innerHTML = `
                    <div class="achievement-item unlocked">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-info">
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-description">${achievement.description}</div>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="workout-item">
                        <div class="workout-name">🎉 ${newAchievements.length} New Achievements!</div>
                        <div class="workout-exercises">
                            ${newAchievements.map(a => `${a.icon} ${a.name}`).join(' • ')}
                        </div>
                    </div>
                `;
            }
            
            card.classList.add('new-achievement-card');
            card.style.display = 'block';
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                card.style.display = 'none';
                card.classList.remove('new-achievement-card');
                // Mark achievements as no longer new
                achievements.forEach(a => a.isNew = false);
                saveData();
            }, 10000);
        }

        function updateAchievementsDisplay() {
            // Update stats
            const unlockedCount = achievements.length;
            const totalCount = achievementDefinitions.length;
            const progressPercent = Math.round((unlockedCount / totalCount) * 100);
            
            document.getElementById('totalAchievements').textContent = `${unlockedCount}/${totalCount}`;
            document.getElementById('achievementProgress').textContent = `${progressPercent}%`;
            
            // Update achievement lists by category
            updateAchievementCategory('workout', 'workoutAchievements');
            updateAchievementCategory('progress', 'progressAchievements');
            updateAchievementCategory('consistency', 'consistencyAchievements');
        }

        function updateAchievementCategory(category, containerId) {
            const container = document.getElementById(containerId);
            const categoryAchievements = achievementDefinitions.filter(def => def.category === category);
            
            container.innerHTML = categoryAchievements.map(def => {
                const unlocked = achievements.find(a => a.id === def.id);
                const unlockedClass = unlocked ? 'unlocked' : '';
                const unlockedDate = unlocked ? 
                    `<div class="achievement-date">Unlocked: ${new Date(unlocked.unlockedDate).toLocaleDateString()}</div>` : '';
                
                return `
                    <div class="achievement-item ${unlockedClass}">
                        <div class="achievement-icon">${def.icon}</div>
                        <div class="achievement-info">
                            <div class="achievement-name">${def.name}</div>
                            <div class="achievement-description">${def.description}</div>
                            ${unlockedDate}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Goals Management
        function saveGoals() {
            goals = {
                steps: parseInt(document.getElementById('stepsGoal').value) || 0,
                water: parseFloat(document.getElementById('waterGoal').value) || 0,
                calories: parseInt(document.getElementById('caloriesGoal').value) || 0,
                weight: parseFloat(document.getElementById('weightGoal').value) || 0
            };
            
            saveData();
            checkAchievements(); // Check for goal-related achievements
            updateGoalsDisplay();
            updateChartsDisplay();
            updateDashboard();
            
            alert('Goals saved successfully!');
        }

        function loadGoals() {
            if (goals.steps) document.getElementById('stepsGoal').value = goals.steps;
            if (goals.water) document.getElementById('waterGoal').value = goals.water;
            if (goals.calories) document.getElementById('caloriesGoal').value = goals.calories;
            if (goals.weight) document.getElementById('weightGoal').value = goals.weight;
        }

        function updateGoalsDisplay() {
            const container = document.getElementById('dailyGoalsProgress');
            
            if (!goals.steps && !goals.water && !goals.calories && !goals.weight) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>Set goals above to see your progress</h4>
                        <p>Track how you're doing against your daily targets</p>
                    </div>
                `;
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const todayData = tracking.find(n => n.date === today) || {};
            const todayWeight = measurements.find(m => m.date === today);

            let progressItems = [];

            if (goals.steps) {
                const current = todayData.steps || 0;
                const progress = Math.min((current / goals.steps) * 100, 100);
                const status = current >= goals.steps ? 'achieved' : 
                             current >= goals.steps * 0.8 ? 'close' : 'needs-work';
                const statusText = current >= goals.steps ? 'Achieved!' : 
                                 current >= goals.steps * 0.8 ? 'Close!' : 'Keep going!';
                
                progressItems.push(`
                    <div class="goal-progress-item ${status}">
                        <div class="goal-header">
                            <div class="goal-name">👟 Steps: ${current.toLocaleString()} / ${goals.steps.toLocaleString()}</div>
                            <div class="goal-status ${status}">${statusText}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `);
            }

            if (goals.water) {
                const current = todayData.water || 0;
                const progress = Math.min((current / goals.water) * 100, 100);
                const status = current >= goals.water ? 'achieved' : 
                             current >= goals.water * 0.8 ? 'close' : 'needs-work';
                const statusText = current >= goals.water ? 'Achieved!' : 
                                 current >= goals.water * 0.8 ? 'Close!' : 'Keep going!';
                
                progressItems.push(`
                    <div class="goal-progress-item ${status}">
                        <div class="goal-header">
                            <div class="goal-name">💧 Water: ${current}L / ${goals.water}L</div>
                            <div class="goal-status ${status}">${statusText}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `);
            }

            if (goals.calories) {
                const current = todayData.calories || 0;
                const progress = Math.min((current / goals.calories) * 100, 100);
                const status = current >= goals.calories ? 'achieved' : 
                             current >= goals.calories * 0.8 ? 'close' : 'needs-work';
                const statusText = current >= goals.calories ? 'Achieved!' : 
                                 current >= goals.calories * 0.8 ? 'Close!' : 'Keep going!';
                
                progressItems.push(`
                    <div class="goal-progress-item ${status}">
                        <div class="goal-header">
                            <div class="goal-name">🔥 Calories: ${current} / ${goals.calories}</div>
                            <div class="goal-status ${status}">${statusText}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `);
            }

            if (goals.weight && todayWeight) {
                const current = todayWeight.weight;
                const diff = Math.abs(current - goals.weight);
                const status = diff <= 0.5 ? 'achieved' : diff <= 2 ? 'close' : 'needs-work';
                const statusText = diff <= 0.5 ? 'At goal!' : diff <= 2 ? 'Close!' : 'Keep going!';
                
                progressItems.push(`
                    <div class="goal-progress-item ${status}">
                        <div class="goal-header">
                            <div class="goal-name">⚖️ Weight: ${current}kg / ${goals.weight}kg</div>
                            <div class="goal-status ${status}">${statusText}</div>
                        </div>
                        <div style="opacity: 0.7; font-size: 14px;">
                            ${diff.toFixed(1)}kg ${current > goals.weight ? 'above' : 'below'} target
                        </div>
                    </div>
                `);
            }

            container.innerHTML = progressItems.join('');
        }

        // Chart Generation Functions
        function updateChartsDisplay() {
            // Steps Chart
            const stepsData = tracking.slice(-14).map(n => n.steps);
            const stepsGoal = goals.steps;
            updateStepsChart(stepsData, stepsGoal);
            
            // Water Chart
            const waterData = tracking.slice(-14).map(n => n.water);
            const waterGoal = goals.water;
            updateWaterChart(waterData, waterGoal);
            
            // Calories Chart
            const caloriesData = tracking.slice(-14).map(n => n.calories);
            const caloriesGoal = goals.calories;
            updateCaloriesChart(caloriesData, caloriesGoal);
        
            // Weight Chart
            const weightData = measurements.slice(-14).map(m => m.weight);
            const weightGoal = goals.weight;
            updateWeightChart(weightData, weightGoal);
        }

        function updateStepsChart(data, goal) {
            generateChart('stepsChart', data, goal, 0, '#10b981');
        }
        
        function updateWaterChart(data, goal) {
            generateChart('waterChart', data, goal, 0, '#06b6d4');
        }
        
        function updateCaloriesChart(data, goal) {
            generateChart('caloriesChart', data, goal, 0, '#f97316');
        }
        
        function updateWeightChart() {
            const container = document.getElementById('weightChart');
            if (!container) return;
            
            const sortedMeasurements = [...measurements].sort((a, b) => new Date(a.date) - new Date(b.date));
            const data = sortedMeasurements.map(m => m.weight);
            
            generateChart('weightChart', data, goals.weight, 60, '#3b82f6');
        }

        function getLast14DaysData(field) {
            const data = [];
            for (let i = 13; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const dayData = tracking.find(n => n.date === dateStr);
                data.push({
                    date: dateStr,
                    value: dayData ? (dayData[field] || 0) : 0
                });
            }
            return data;
        }

        
        // Charting Functions
        function generateChart(containerId, data, goal, yMin = 0, barColor = "#3b82f6") {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <h4>No data yet</h4>
                    <p>Start tracking to see your progress chart</p>
                </div>`;
                return;
            }
        
            const margin = { top: 20, right: 20, bottom: 30, left: 40 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = 200 - margin.top - margin.bottom;
        
            container.innerHTML = '';
        
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
        
            const dataMax = Math.max(...data.filter(d => !isNaN(d) && d !== null));
            const goalMax = goal || 0;
            const yMax = Math.max(dataMax, goalMax) * 1.1;
        
            const xScale = d3.scaleBand()
                .domain(data.map((d, i) => i))
                .range([0, width])
                .padding(0.2);
        
            const yScale = d3.scaleLinear()
                .domain([yMin, yMax])
                .range([height, 0]);
        
            // Y-axis
            svg.append('g')
                .attr('class', 'chart-axis')
                .call(d3.axisLeft(yScale).ticks(5));
        
            // X-axis line
            svg.append('line')
                .attr('class', 'chart-axis')
                .attr('x1', 0)
                .attr('y1', height)
                .attr('x2', width)
                .attr('y2', height);
        
            // ---- Gradient definition ----
            const gradientId = `${containerId}-gradient`;
            const defs = svg.append("defs");
            const gradient = defs.append("linearGradient")
                .attr("id", gradientId)
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "0%")
                .attr("y2", "100%");
        
            gradient.append("stop")
                .attr("offset", "0%")
                .attr("stop-color", d3.color(barColor).brighter(1));
        
            gradient.append("stop")
                .attr("offset", "100%")
                .attr("stop-color", d3.color(barColor).darker(1));
        
            // ---- Bars with semi-circle tops ----
            svg.selectAll('.bar')
                .data(data)
                .enter().append('path')
                .attr('d', (d, i) => {
                    const x = xScale(i);
                    const barWidth = xScale.bandwidth();
                    const barHeight = height - yScale(d);
                    const y = yScale(d);
        
                    const radius = Math.min(barWidth / 2, barHeight);
        
                    return `
                        M${x},${y + radius}
                        v${barHeight - radius}
                        h${barWidth}
                        v${- (barHeight - radius)}
                        a${radius},${radius} 0 0 0 -${barWidth},0
                        Z
                    `;
                })
                .attr('fill', `url(#${gradientId})`);
        
            // ---- Goal line + label (always on top) ----
            if (goal) {
                svg.append('line')
                    .attr('class', 'goal-line')
                    .attr('x1', 0)
                    .attr('x2', width)
                    .attr('y1', yScale(goal))
                    .attr('y2', yScale(goal));
        
                svg.append('text')
                    .attr('x', width - 5)
                    .attr('y', yScale(goal) - 5)
                    .attr('text-anchor', 'end')
                    .attr('class', 'goal-label')
                    .text(`Goal: ${goal}`);
            }
        }


        // Show workout reminder on dashboard page
        function showWorkoutReminder() {
            const today = new Date();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const todayName = dayNames[today.getDay()];
            const todayShort = todayName === 'Sun' ? 'Sun' : todayName;
        
            const card = document.getElementById('workoutReminderCard');
            const content = document.getElementById('workoutReminder');
        
            // Check if there's an active schedule
            if (!schedule.planName) {
                // Only try to hide the card if it exists
                if (card) {
                    card.style.display = 'none';
                }
                return;
            }
        
            // Check if workout is scheduled for today
            const workoutId = schedule.weekSchedule[todayShort];
            if (!workoutId) {
                // Only try to hide the card if it exists
                if (card) {
                    card.style.display = 'none';
                }
                return;
            }
        
            // Check if already completed today
            const todayStr = today.toISOString().split('T')[0];
            const alreadyCompleted = workoutCompletions.find(w => w.date === todayStr);
        
            if (alreadyCompleted) {
                content.innerHTML = `
                    <div class="workout-item">
                        <div class="workout-name">✅ Today's workout completed!</div>
                        <div class="workout-exercises">Great job finishing "${alreadyCompleted.workoutName}"</div>
                    </div>
                `;
                if (card) {
                    card.classList.remove('reminder-card');
                }
            } else {
                const workout = workouts.find(w => w.id === workoutId);
                content.innerHTML = `
                    <div class="workout-item">
                        <div class="workout-name">⏰ Time to workout!</div>
                        <div class="workout-exercises">
                            You have "${workout?.name || 'Workout'}" scheduled for today
                        </div>
                        <button class="btn btn-small" onclick="logWorkoutCompletion()" style="margin-top: 8px;">
                            Mark as Completed
                        </button>
                    </div>
                `;
                if (card) {
                    card.classList.add('reminder-card');
                }
            }
            
            // Only try to show the card if it exists
            if (card) {
                card.style.display = 'block';
            }
        }
        function saveTracking() {
            const date = document.getElementById('trackingDate').value;
            const calories = document.getElementById('calories').value;
            const protein = document.getElementById('protein').value;
            const water = document.getElementById('water').value;
            const steps = document.getElementById('dailySteps').value;

            if (!date) {
                alert('Please select a date.');
                return;
            }

            const existingEntryIndex = tracking.findIndex(entry => entry.date === date);
        
            const newEntry = {
                date,
                calories: calories ? parseInt(calories) : 0,
                protein: protein ? parseInt(protein) : 0,
                water: water ? parseFloat(water) : 0,
                steps: steps ? parseInt(steps) : 0
            };

            if (existingEntryIndex !== -1) {
                tracking[existingEntryIndex] = newEntry;
            } else {
                tracking.push(newEntry);
                tracking.sort((a, b) => new Date(a.date) - new Date(b.date));
            }
        
            window.localStorage?.setItem('fittrack-tracking', JSON.stringify(tracking));
        
            // After saving, update all displays to reflect the new data
            updateAllDisplays();
            
            alert('Daily data saved!');
        }

        // Update Daily Tracking Section
        function updateDailyTrackingHistory() {
            const container = document.getElementById('dailyTrackingHistory');
        
            if (tracking.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>No daily data yet</h4>
                        <p>Start tracking your daily metrics above!</p>
                    </div>
                `;
                return;
            }
        
            const grouped = {};
            tracking.forEach(entry => {
                const date = new Date(entry.date);
                const key = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(entry);
            });
        
            const sortedMonths = Object.keys(grouped).sort((a, b) => {
                const aDate = new Date(a);
                const bDate = new Date(b);
                return bDate - aDate; // newest first
            });
        
            container.innerHTML = sortedMonths.map((monthKey, i) => {
                const entries = grouped[monthKey]
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
        
                const totals = entries.reduce((acc, e) => {
                    acc.calories += e.calories || 0;
                    acc.protein += e.protein || 0;
                    acc.water += e.water || 0;
                    acc.steps += e.steps || 0;
                    return acc;
                }, { calories: 0, protein: 0, water: 0, steps: 0 });
        
                const entriesHtml = entries.map(entry => `
                    <div class="workout-item">
                        <div class="workout-header">
                            <div>
                                <div class="workout-name">${new Date(entry.date).toLocaleDateString()}</div>
                                <div class="workout-exercises">
                                    🔥 ${entry.calories} cal • 🥩 ${entry.protein}g protein • 💧 ${entry.water}L water • 👟 ${entry.steps.toLocaleString()} steps
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
        
                const collapsed = i === 0 ? "" : "collapsed";
                const displayStyle = i === 0 ? "block" : "none";
                const arrowRotation = i === 0 ? "rotate(90deg)" : "rotate(0deg)";
        
                return `
                    <div class="month-group">
                        <div class="month-header ${collapsed}">
                            <span class="arrow" style="transform:${arrowRotation}">▶</span>
                            <strong>${monthKey}</strong>
                        </div>
                        <div class="month-totals-bubble">
                            🔥 ${totals.calories.toLocaleString()} cal • 
                            🥩 ${totals.protein.toLocaleString()}g protein • 
                            💧 ${totals.water.toLocaleString()}L water • 
                            👟 ${totals.steps.toLocaleString()} steps
                        </div>
                        <div class="month-entries" style="display:${displayStyle}">${entriesHtml}</div>
                    </div>
                `;
            }).join('');
        
            document.querySelectorAll('.month-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('collapsed');
                    const arrow = header.querySelector('.arrow');
                    if (arrow) arrow.style.transform = header.classList.contains('collapsed')
                        ? 'rotate(0deg)'
                        : 'rotate(90deg)';
        
                    const entriesDiv = header.parentElement.querySelector('.month-entries');
                    if (entriesDiv) {
                        entriesDiv.style.display = header.classList.contains('collapsed')
                            ? 'none'
                            : 'block';
                    }
                });
            });
        }


        // Measurements Management
        function saveMeasurements() {
            let weightValue = document.getElementById('weight').value;
            let weight = weightValue !== "" ? parseFloat(weightValue) : null;
        
            // Save height separately as a global value
            let heightValue = document.getElementById("height").value;
            if (heightValue !== "") {
                localStorage.setItem("fittrack-height", parseFloat(heightValue));
            }
        
            const measurement = {
                id: Date.now(),
                date: document.getElementById('measurementDate').value,
                weight: weight,
                bodyFat: parseFloat(document.getElementById('bodyFat').value) || null,
                muscleMass: parseFloat(document.getElementById('muscleMass').value) || null,
                waist: parseFloat(document.getElementById('waist').value) || null
            };
        
            if (!measurement.date) {
                alert('Please select a date');
                return;
            }
        
            // Remove any existing entry with the same date
            measurements = measurements.filter(m => m.date !== measurement.date);
        
            // Add the new one at the start
            measurements.unshift(measurement);
        
            // Save to localStorage
            window.localStorage.setItem('fittrack-measurements', JSON.stringify(measurements));
        
            // Update the global variable
            window.measurements = measurements;
        
            // Clear the form (except height, since it’s global)
            document.getElementById('weight').value = '';
            document.getElementById('bodyFat').value = '';
            document.getElementById('muscleMass').value = '';
            document.getElementById('waist').value = '';
        
            // Refresh displays
            updateProgressHistory();
            updateDashboard?.();
        
            alert('Measurements saved!');
        }


        function deleteMeasurement(id) {
            if (confirm('Are you sure you want to delete this measurement?')) {
                // Always reload from localStorage
                let measurements = JSON.parse(window.localStorage.getItem('fittrack-measurements') || '[]');
        
                // Find the index of the measurement to delete
                const index = measurements.findIndex(m => String(m.id) === String(id));
        
                if (index !== -1) {
                    measurements.splice(index, 1);
        
                    // Save updated array
                    window.localStorage.setItem('fittrack-measurements', JSON.stringify(measurements));
        
                    // Update the global variable too (if you have one)
                    window.measurements = measurements;
        
                    // Refresh displays
                    updateProgressHistory();
                    updateDashboard?.();
        
                    alert('Measurement deleted.');
                }
            }
        }

        // Calculate BMI for the badge on dashboard
        function updateBMIBadge() {
            const height = parseFloat(localStorage.getItem("fittrack-height"));
            const latest = measurements.length > 0 ? measurements[0] : null;  
            const badge = document.getElementById("bmiBadge");
            if (!badge) return;
        
            if (!height || !latest || !latest.weight) {
                badge.innerText = "";
                badge.style.display = "none";
                return;
            }
        
            const bmi = (latest.weight / ((height / 100) ** 2)).toFixed(1);
            let color = "";
        
            if (bmi < 18.5) color = "#3498db";      // blue
            else if (bmi < 25) color = "#27ae60";   // green
            else if (bmi < 30) color = "#f39c12";   // orange
            else color = "#e74c3c";                 // red
        
            badge.innerText = `BMI: ${bmi}`;
            badge.style.background = color;
            badge.style.display = "inline-block";
        }


        function updateProgressHistory() {
            const container = document.getElementById('progressHistory');
            if (!container) return;
        
            // Always reload fresh data from localStorage
            let measurements = JSON.parse(window.localStorage.getItem('fittrack-measurements') || '[]');
        
            if (measurements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>No measurements yet</h4>
                        <p>Take your first measurements above!</p>
                    </div>
                `;
                return;
            }
        
            // Sort measurements by date (newest first)
            const sortedMeasurements = [...measurements].sort((a, b) => new Date(b.date) - new Date(a.date));
        
            container.innerHTML = sortedMeasurements.map(measurement => `
                <div class="workout-item">
                    <div class="workout-header">
                        <div>
                            <div class="workout-name">${new Date(measurement.date).toLocaleDateString()}</div>
                            <div class="workout-exercises">
                                ⚖️ ${measurement.weight}kg • 📊 ${measurement.bodyFat}% BF • 💪 ${measurement.muscleMass}kg muscle • 📏 ${measurement.waist}cm waist
                            </div>
                        </div>
                        <button class="btn-delete" onclick="deleteMeasurement('${measurement.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                                <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        
            // Update global state so it’s consistent elsewhere
            window.measurements = measurements;
        }

        // ******************************************* 
        // Challenges Section
        function toggleChallengeForm() {
          const container = document.getElementById("challengeFormContainer");
          const chevron = document.querySelector(".challenge-create-header .chevron");
          const isOpen = container.style.display === "block";
          container.style.display = isOpen ? "none" : "block";
          chevron.classList.toggle("open", !isOpen);
        }
        
        document.getElementById("challengeType").addEventListener("change", updateChallengeOptions);
        
        function updateChallengeOptions() {
          const type = document.getElementById("challengeType").value;
          const container = document.getElementById("challengeOptions");
        
          if (type === "pushups") {
            container.innerHTML = `
              <label>Reps per Day:</label>
              <input type="number" id="repsPerDay" min="1" required>
              <label>Duration (Days):</label>
              <input type="number" id="durationDays" min="1" required>
            `;
          } else {
            container.innerHTML = `
              <label>Distance (KM):</label>
              <input type="number" id="distanceKm" min="0" step="0.1" required>
        
              <label>Frequency:</label>
              <select id="frequency" required>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="weekend">Weekend</option>
              </select>
        
              <div id="distanceDurationContainer" style="margin-top:10px;"></div>
            `;
        
            // Attach ONE listener after the HTML exists
            document.getElementById("frequency").addEventListener("change", updateDistanceDuration);
            // Initial render of the duration controls for the default frequency
            updateDistanceDuration();
          }
        }
        
        // Run once on load
        updateChallengeOptions();

        // Create Challenge
        function createChallenge(e) {
            e.preventDefault();
            const type = document.getElementById("challengeType").value;
            const startDateInput = document.getElementById("startDate").value;
            const startDate = startDateInput ? new Date(startDateInput) : new Date();
        
            function capitalizeWords(str) {
                return str.replace(/\b\w/g, char => char.toUpperCase());
            }
        
            let challenge = {
                type,
                createdAt: new Date().toISOString(),
                startDate: startDate.toISOString(),
                progress: []
            };
        
            if (type === "pushups") {
                challenge.repsPerDay = +document.getElementById("repsPerDay").value;
                challenge.durationDays = +document.getElementById("durationDays").value;
                challenge.title = `${challenge.repsPerDay} Push-Ups/Day for ${challenge.durationDays} Days`;
        
                // Daily checkboxes
                challenge.progress = Array(challenge.durationDays).fill(false);
        
            } else {
                challenge.distanceKm = +document.getElementById("distanceKm").value;
                challenge.frequency = document.getElementById("frequency").value;
        
                if (challenge.frequency === "daily") {
                    // User chooses number of days
                    challenge.durationDays = +document.getElementById("durationDays").value;
                    challenge.totalDistance = challenge.distanceKm * challenge.durationDays;   // ✅ total goal
                    challenge.title = `${capitalizeWords(type)} ${challenge.distanceKm} KM Daily for ${challenge.durationDays} Days`;
                    challenge.progress = Array(challenge.durationDays).fill(0);
        
                } else if (challenge.frequency === "weekly") {
                    const weeks = +document.getElementById("challengeDurationWeeks").value;
                    challenge.durationDays = weeks * 7;
                    challenge.totalDistance = challenge.distanceKm * weeks;   // ✅ total goal
                    challenge.title = `${capitalizeWords(type)} ${challenge.distanceKm} KM Weekly for ${weeks} Weeks`;
                    challenge.progress = Array(weeks).fill(0);
        
                } else if (challenge.frequency === "weekend") {
                    // Fixed at 2 days
                    challenge.durationDays = 2;
                    challenge.totalDistance = challenge.distanceKm * 2;   // ✅ total goal
                    challenge.title = `${capitalizeWords(type)} ${challenge.distanceKm} KM Weekend Challenge`;
                    challenge.progress = Array(2).fill(0);
                }
            }

            if (challenge.frequency === "daily") {
                challenge.durationDays = +document.getElementById("durationDays").value;
            } else if (challenge.frequency === "weekly") {
                const weeks = +document.getElementById("challengeDurationWeeks").value;
                challenge.durationDays = weeks * 7; // store as total days
            } else if (challenge.frequency === "weekend") {
                challenge.durationDays = 2; // Sat + Sun
            }

            let challenges = JSON.parse(localStorage.getItem("challenges")) || [];
            challenges.push(challenge);
            localStorage.setItem("challenges", JSON.stringify(challenges));
        
            displayChallenges();
            document.getElementById("challengeForm").reset();
            updateChallengeOptions();
        }

        // Display challenges
        function displayChallenges() {
            let challenges = JSON.parse(localStorage.getItem("challenges")) || [];
            let completedChallenges = JSON.parse(localStorage.getItem("completedChallenges")) || [];
        
            const activeContainer = document.getElementById("activeChallenges");
            const completedContainer = document.getElementById("completedChallenges");
        
            activeContainer.innerHTML = "";
            completedContainer.innerHTML = "";
        
            // Render active challenges
            challenges.forEach((challenge, index) => {
                const div = document.createElement("div");
                div.className = "challenge-item";
                div.id = `challenge-${challenge.id || index}`;
            
                // Header with title + quit button
                const header = document.createElement("div");
                header.className = "challenge-header";
                header.innerHTML = `
                    <strong>${challenge.title}</strong>
                    <button class="btn-quit" onclick="quitChallenge(${index})">Quit</button>
                `;
                div.appendChild(header);
            
                // Dates (start + expected end)
                if (challenge.startDate) {
                    const start = new Date(challenge.startDate);
                    const end = new Date(start);
                
                    // Use durationDays if present, otherwise weeks
                    if (challenge.durationDays) {
                        end.setDate(start.getDate() + challenge.durationDays);
                    } else if (challenge.durationWeeks) {
                        end.setDate(start.getDate() + (challenge.durationWeeks * 7));
                    }
                
                    const datesDiv = document.createElement("div");
                    datesDiv.className = "challenge-dates";
                    datesDiv.innerHTML = `
                        <span>Start Date: ${start.toLocaleDateString()}</span>
                        <span class="end-date">End Date: ${end.toLocaleDateString()}</span>
                    `;
                    div.appendChild(datesDiv);
                }

                if (challenge.type === "pushups") {
                    // Push-up checkboxes
                    const progressDiv = document.createElement("div");
                    progressDiv.className = "challenge-progress pushup-progress";
                    challenge.progress.forEach((done, dayIndex) => {
                        const label = document.createElement("label");
                        label.style = "display:inline-flex; align-items:center; margin-right:8px;";
                        label.innerHTML = `
                            <input type="checkbox" 
                                   onchange="updatePushupProgress(${index}, ${dayIndex}, this.checked)" 
                                   ${done ? "checked" : ""}>
                            <span style="margin-left:4px;">Day ${dayIndex + 1}</span>
                        `;
                        progressDiv.appendChild(label);
                    });
                    div.appendChild(progressDiv);
            
                } else if (challenge.type === "running" || challenge.type === "cycling") {
                    const totalLogged = challenge.progress.reduce((a, b) => a + (parseFloat(b) || 0), 0);
                    const target = challenge.distanceKm * (challenge.durationDays || challenge.durationWeeks || 1);
                    const percent = Math.min((totalLogged / target) * 100, 100);
            
                    // Progress bar
                    const barWrapper = document.createElement("div");
                    barWrapper.className = "challenge-progress-bar";
                    const bar = document.createElement("div");
                    bar.className = "challenge-progress-fill";
                    bar.style.width = percent + "%";
                    barWrapper.appendChild(bar);
                    div.appendChild(barWrapper);
            
                    // Progress text
                    const progressText = document.createElement("p");
                    progressText.className = "day-input";
                    progressText.innerText = `${totalLogged.toFixed(1)} / ${target} km`;
                    div.appendChild(progressText);
            
                    // Daily inputs
                    const inputDiv = document.createElement("div");
                    inputDiv.className = "challenge-progress";
                    challenge.progress.forEach((val, dayIndex) => {
                        const label = document.createElement("label");
                        label.className = "day-input";
                        label.innerHTML = `
                            Day ${dayIndex + 1}:
                            <input type="number" min="0" step="0.1" value="${val || ""}" 
                                   onchange="updateDistanceProgress(${index}, ${dayIndex}, this.value)">
                            km
                        `;
                        inputDiv.appendChild(label);
                    });
                    div.appendChild(inputDiv);
                }
            
                activeContainer.appendChild(div);
            });

        
            // Render completed challenges
            completedChallenges.forEach((challenge, index) => {
                const div = document.createElement("div");
                div.className = "completed-challenge-item";
            
                // Header with title + badge
                const header = document.createElement("div");
                header.className = "completed-header";
                header.innerHTML = `
                    <span class="completed-title">${challenge.title}</span>
                    <span class="completed-badge">✓ Completed</span>
                `;
                div.appendChild(header);
            
                // Dates
                const dates = document.createElement("div");
                dates.className = "completed-dates";
                const start = challenge.startDate ? new Date(challenge.startDate) : null;
                const end = challenge.endDate ? new Date(challenge.endDate) : null;
                
                dates.innerHTML = `
                    <span>Start: ${start ? start.toLocaleDateString() : "Unknown"}</span>
                    <span class="end-date">End: ${end ? end.toLocaleDateString() : "Unknown"}</span>
                `;
                div.appendChild(dates);
            
                // Details
                const details = document.createElement("div");
                details.className = "completed-details";
            
                if (challenge.type === "pushups") {
                    const totalDays = challenge.progress.length;
                    const totalPushups = challenge.progress.filter(Boolean).length;
                    details.innerText = `${totalDays} days • ${totalPushups} push-ups logged`;
                } else if (challenge.type === "running" || challenge.type === "cycling") {
                    const totalDays = challenge.progress.length;
                    const totalDistance = challenge.progress.reduce((a, b) => a + (parseFloat(b) || 0), 0).toFixed(1);
                    details.innerText = `${totalDays} days • ${totalDistance} km`;
                }
            
                div.appendChild(details);
            
                completedContainer.appendChild(div);
            });

        }

        
        function updatePushupProgress(challengeIndex, dayIndex, checked) {
          let challenges = JSON.parse(localStorage.getItem("challenges")) || [];
          challenges[challengeIndex].progress[dayIndex] = checked;
          localStorage.setItem("challenges", JSON.stringify(challenges));
          updateChallengeProgress(challenges[challengeIndex], challengeIndex);
          displayChallenges();
        }
        
        function updateDistanceProgress(challengeIndex, dayIndex, value) {
            let challenges = JSON.parse(localStorage.getItem("challenges")) || [];
            challenges[challengeIndex].progress[dayIndex] = Number(value);
            localStorage.setItem("challenges", JSON.stringify(challenges));
            updateChallengeProgress(challenges[challengeIndex], challengeIndex);
            displayChallenges();
        }

        function updateDistanceDuration() {
          const freq = document.getElementById("frequency").value;
          const holder = document.getElementById("distanceDurationContainer");
          if (!holder) return;
        
          if (freq === "daily") {
            holder.innerHTML = `
              <label>Duration (Days):</label>
              <input type="number" id="durationDays" min="1" value="7" required>
            `;
          } else if (freq === "weekly") {
            holder.innerHTML = `
              <label>Duration (Weeks):</label>
              <input type="number" id="challengeDurationWeeks" min="1" value="4" required>
            `;
          } else {
            holder.innerHTML = `
              <div class="hint" style="opacity:.8;font-size:12px;">
                Covers the first Saturday & Sunday after your start date.
              </div>
            `;
          }
        }


        function quitChallenge(index) {
            let challenges = JSON.parse(localStorage.getItem("challenges")) || [];
            if (confirm("Are you sure you want to quit this challenge?")) {
                challenges.splice(index, 1);
                localStorage.setItem("challenges", JSON.stringify(challenges));
                displayChallenges();
            }
        }

        function showCompletionMessage(challenge) {
          let challengeName = challenge && challenge.name ? challenge.name : "your";
          // Show a simple popup
          alert(`🎉 Congratulations! You completed the "${challengeName}" challenge!`);
        
          // Optional: add a confetti effect
          if (typeof confetti === "function") {
            confetti({
              particleCount: 200,
              spread: 100,
              origin: { y: 0.6 }
            });
          }
        }

        function updateChallengeProgress(challenge, challengeIndex) {
          const challenges = JSON.parse(localStorage.getItem("challenges") || "[]");
          const completedChallenges = JSON.parse(localStorage.getItem("completedChallenges") || "[]");
        
          let isComplete = false;
        
          if (challenge.type === "pushups") {
            isComplete = challenge.progress.every(Boolean);
          } else if (challenge.type === "running" || challenge.type === "cycling") {
            const totalLogged = (challenge.progress || []).reduce((a, b) => a + (parseFloat(b) || 0), 0);
            const totalTarget = Number(challenge.totalDistance || 0);
            isComplete = totalLogged >= totalTarget && totalTarget > 0;
          }
        
          if (isComplete) {
            showCompletionMessage(challenge.name || challenge.title || "Challenge");
            challenge.completedAt = new Date().toISOString();
            completedChallenges.push(challenge);
            challenges.splice(challengeIndex, 1);
            localStorage.setItem("completedChallenges", JSON.stringify(completedChallenges));
            localStorage.setItem("challenges", JSON.stringify(challenges));
          } else {
            challenges[challengeIndex] = challenge;
            localStorage.setItem("challenges", JSON.stringify(challenges));
          }
        
          displayChallenges();
        }
      

        // Move completed challenges to completed section
        function moveToCompletedChallenges(challenge) {
            challenge.endDate = new Date().toISOString();
            // Remove from active list
            const activeDiv = document.getElementById(`challenge-${challenge.id}`);
            if (activeDiv) activeDiv.remove();
        
            // Add to completed section
            const completedContainer = document.getElementById("completedChallenges");
            const div = document.createElement("div");
            div.className = "completed-challenge";
            div.innerHTML = `
                <strong>${challenge.type.toUpperCase()} Challenge Completed!</strong>
                <p>🎉 Well done! You finished your challenge.</p>
            `;
            completedContainer.appendChild(div);
        }

        // Fun function to show the challenge is complete, with confetti
        function celebrateCompletion(challenge) {
            alert(`🎉 Congratulations! You completed your ${challenge.type} challenge! 🎉`);
            
            // Optional: simple confetti effect
            const duration = 3 * 1000;
            const end = Date.now() + duration;
        
            (function frame() {
                const confetti = document.createElement("div");
                confetti.textContent = "🎊";
                confetti.style.position = "fixed";
                confetti.style.left = Math.random() * 100 + "vw";
                confetti.style.top = "-10px";
                confetti.style.fontSize = "24px";
                confetti.style.animation = "fall 3s linear";
                document.body.appendChild(confetti);
        
                setTimeout(() => confetti.remove(), 3000);
        
                if (Date.now() < end) requestAnimationFrame(frame);
            })();
        }

        // Show challenge reminder on dashboard screen
        function showActiveChallengeReminder() {
            let challenges = JSON.parse(localStorage.getItem("challenges") || "[]");
        
            // Ensure challenges is an array
            const activeChallenges = Array.isArray(challenges) 
                ? challenges.filter(c => !c.completed) 
                : [];
        
            const reminder = document.getElementById("challengeReminder");
        
            // Reset reminder content
            reminder.innerHTML = "";
        
            let hasContent = false;
        
            // === Active Challenges Reminder ===
            if (activeChallenges.length > 0) {
                hasContent = true;
        
                const list = activeChallenges.map(c => `
                    <div class="reminder-sub">${c.title}</div>
                `).join("");
        
                const challengeBox = document.createElement("div");
                challengeBox.className = "reminder-card";
                challengeBox.style.background = "#fff3cd"; // yellow
                challengeBox.innerHTML = `
                    <div class="reminder-title">Active Challenges</div>
                    ${list}
                    <button class="reminder-btn" id="reminderOpen">
                        See The Challenges
                    </button>
                `;
                reminder.appendChild(challengeBox);
        
                // Button handler
                document.getElementById("reminderOpen").addEventListener("click", () => {
                    showSection("challenges", document.querySelector('button.nav-item[onclick*="challenges"]'));
                });
            }
        
            // === Yoga/Stretching Reminder ===
            const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
            const yogaDone = localStorage.getItem("yogaDoneDate") === today;
        
            if (!yogaDone) {
                hasContent = true;
        
                const yogaBox = document.createElement("div");
                yogaBox.className = "reminder-card";
                yogaBox.style.background = "#d4edda"; // light green
                yogaBox.innerHTML = `
                    <div class="reminder-title">Have you done your yoga and stretching today?</div>
                    <button class="reminder-btn" id="yogaYes">Yes</button>
                `;
                reminder.appendChild(yogaBox);
        
                document.getElementById("yogaYes").addEventListener("click", () => {
                    localStorage.setItem("yogaDoneDate", today);
                    yogaBox.style.display = "none"; // hide after confirming
                });
            }
        
            // Hide container if nothing to show
            reminder.style.display = hasContent ? "block" : "none";
        }



        // ***********************************
        // Dashboard Updates
        function updateDashboard() {
            document.getElementById('totalWorkouts').textContent = workoutCompletions.length;
            
            // Average steps for the last 7 days
            const last7DaysTracking = tracking.slice(-7);
            const avgSteps = last7DaysTracking.length > 0 ? 
                Math.round(last7DaysTracking.reduce((sum, n) => sum + (n.steps || 0), 0) / last7DaysTracking.length) : 0;
            document.getElementById('avgSteps').textContent = avgSteps.toLocaleString();
            
            // Current weight and change
            if (measurements.length > 0) {
                const sortedMeasurements = [...measurements].sort((a, b) => new Date(a.date) - new Date(b.date));
                const latest = sortedMeasurements[sortedMeasurements.length - 1];
                document.getElementById('currentWeight').textContent = latest.weight;
            
                if (sortedMeasurements.length > 1) {
                    const earliest = sortedMeasurements[0];
                    const change = latest.weight - earliest.weight;
                    const changeText = change >= 0 ? `+${change.toFixed(1)}` : `${change.toFixed(1)}`;
                    document.getElementById('weightChange').textContent = changeText;
            
                    const weightGoal = goals.find(g => g.type === 'weight');
            
                    if (weightGoal) {
                        // Compare target vs latest
                        if (latest.weight > weightGoal.target) {
                            // Still above target → green if going down
                            document.getElementById('weightChange').style.color = change < 0 ? '#10b981' : '#ef4444';
                        } else if (latest.weight < weightGoal.target) {
                            // Still below target → green if going up
                            document.getElementById('weightChange').style.color = change > 0 ? '#10b981' : '#ef4444';
                        } else {
                            document.getElementById('weightChange').style.color = '#ffffff'; // exactly at goal
                        }
                    } else {
                        // No goal set → just show green for loss, red for gain
                        document.getElementById('weightChange').style.color = change < 0 ? '#10b981' : '#ef4444';
                    }
                } else {
                    document.getElementById('weightChange').textContent = '0';
                }
            } else {
                document.getElementById('currentWeight').textContent = '0';
                document.getElementById('weightChange').textContent = '0';
            }

            showActiveChallengeReminder();
            updateBMIBadge();
        }

        // Greeting
        function showGreeting() {
            const greetingEl = document.getElementById("greeting");
            if (!greetingEl) return;
        
            const now = new Date();
            const hour = now.getHours();
        
            let greetingText = "Hello";
            let emoji = "👋";
        
            if (hour >= 23 || hour < 5) {
                greeting = "Take a break, get some rest";
                emoji = "🌅";
            } else if (hour >= 5 && hour < 12) {
                greeting = "Good morning";
                emoji = "🌅";
            } else if (hour >= 12 && hour < 17) {
                greetingText = "Good afternoon";
                emoji = "☀️";
            } else {
                greetingText = "Good evening";
                emoji = "🌙";
            }
        
            greetingEl.innerHTML = `<h5>${greetingText}, Barry! ${emoji} </h5>`;
        }

        
        // Data Management
        function saveData() {
            if (window.localStorage) {
                window.localStorage.setItem('fittrack-workouts', JSON.stringify(workouts));
                window.localStorage.setItem('fittrack-plans', JSON.stringify(plans));
                window.localStorage.setItem('fittrack-schedule', JSON.stringify(schedule));
                window.localStorage.setItem('fittrack-tracking', JSON.stringify(tracking));
                window.localStorage.setItem('fittrack-measurements', JSON.stringify(measurements));
                window.localStorage.setItem('fittrack-achievements', JSON.stringify(achievements));
                window.localStorage.setItem('fittrack-completions', JSON.stringify(workoutCompletions));
                window.localStorage.setItem('fittrack-goals', JSON.stringify(goals));
            }
        }

        function loadData() {
            // Data already loaded in initialization
        }

        window.onload = function() {
            showSection('dashboard', document.querySelector('.nav-item.active'));
            updateAllDisplays();
            showGreeting();
        };

        function updateAllDisplays() {
            displayExerciseLibrary();
            updateWorkoutsList();
            updatePlansList();
            updatePlanSelector();
            updateCurrentSchedule();
            updateTodaysWorkout();
            updateDailyTrackingHistory();
            updateProgressHistory();
            updateAchievementsDisplay();
            updateGoalsDisplay();
            updateChartsDisplay();
            showWorkoutReminder();
            updateDashboard();
            checkAchievements(); // Check achievements on app load
        }

        // Event Listeners
        document.getElementById('planToSchedule').addEventListener('change', generateWeeklySchedule);
        // Close modal if user clicks outside the modal content
        window.addEventListener("click", (e) => {
          const modal = document.getElementById("feedbackModal");
          if (e.target === modal) {
            closeFeedbackModal();
          }
        });
    </script>
</body>
</html>
